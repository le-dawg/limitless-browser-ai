(()=>{let e;(()=>{const t="__app_hrp",s="production",r=!1;if(e=globalThis[t],e)return;const i={name:t,env:s,get:e=>e in i?i[e]:null,...JSON.parse('{"version":"11.4.0"}')},a=function e(t){const s=t===i,n=s&&r,a={},h=e=>Object.assign(t,e),c=new Proxy(t,{get(r,i){if("assign"===i)return h;if(s&&!String(i).startsWith("$"))return t[i];if(!(i in t)){if(t[i]={},s){const e=o.bind(null,"log",i,!1),s=o.bind(null,"log",i,!0),r=o.bind(null,"warn",i,!1),n=o.bind(null,"warn",i,!0),a=o.bind(null,"error",i,!1),h=o.bind(null,"error",i,!0),c=l.bind(null,i);Object.defineProperties(t[i],{log:{get:()=>e},logDev:{get:()=>s},warn:{get:()=>r},warnDev:{get:()=>n},error:{get:()=>a},errorDev:{get:()=>h},Error:{get:()=>c}})}a[i]=e(t[i]),n&&(globalThis[i]=t[i])}return i in a?a[i]:t[i]},set:(e,s,r)=>(t[s]=r,a[s]=r,n&&(globalThis[s]=t[s]),!0)});return c}(i);function o(e,t,s,...r){if(s)return;const[i,a,o]=function(e){let t=0;e.split("").forEach(((s,r)=>{t=e.charCodeAt(r)+((t<<5)-t)}));return[(16711680&t)>>16,(65280&t)>>8,255&t]}(t);n[e](`%c[${t}]`,`color: rgb(${i}, ${a}, ${o})`,...r)}function l(e,t,...s){return s.length>0&&o("error",e,!1,t,...s),new Error(`[${e}] ${t}`)}globalThis[t]=a,e=a})();const t=e=>{const t=globalThis.__hrp_globals||{},s={},r=(e,t)=>"function"==typeof t&&/^[a-z]/.test(e);return new Proxy(e,{get(n,i){let a=t[i]||e[i];return r(i,a)&&(s[i]??=a.bind(e),a=s[i]),a},set:(t,n,i)=>(e[n]=i,r(n,i)&&(s[n]=i.bind(e)),!0)})},s=e=>{try{return r[e]}catch{return globalThis[e]}},r=t(globalThis),n=(globalThis.top===globalThis||t(globalThis.top),s("logger")||s("console")),i=(s("Audio"),s("Blob")),a=(s("CSSStyleSheet"),s("CanvasRenderingContext2D"),s("CustomEvent"),s("DOMParser"),s("Event"),s("File")),o=(s("FileReader"),s("HTMLAnchorElement"),s("HTMLElement"),s("HTMLImageElement"),s("HTMLVideoElement"),s("Headers"),s("Image"),s("IntersectionObserver"),s("MouseEvent"),s("MutationObserver"),s("Node"),s("NodeFilter"),s("NodeList"),s("Request"),s("ResizeObserver"),s("Response"),s("SVGElement"),s("URL")),l=(s("WebSocket"),s("Worker"),s("XMLHttpRequest"),s("XMLSerializer"),s("XPathResult"),s("alert"),s("atob"),s("btoa"),s("chrome")),h=(s("clearInterval"),s("clearTimeout"),s("document")),c=s("fetch"),u=(s("getComputedStyle"),s("getSelection"),s("history"),s("indexedDB"),s("location")),_=(s("navigator"),s("parent")),d=(s("requestAnimationFrame"),s("screen"),s("setInterval"),s("setTimeout"));let b=null;try{b=s("localStorage")}catch{}let g=null;try{g=s("sessionStorage")}catch{}(()=>{const{$bus:t,$env:s,$utils:n}=e;t.controller={async init(){t.on=this.on.bind(this),t.off=this.off.bind(this),t.once=this.once.bind(this),t.send=this._wrapThrowIfError(this.send),t.call=this._wrapThrowIfError(this.call),t.poll=this.poll.bind(this),t.getTabId=this.getTabId.bind(this),this._locus=s.getLocus(),this._serialize=this._serialize.bind(this),this._handlers={},this._is("pp")?(this._setupPp(),this._tabId=await t.getTabId()):this._is("bg")?(this._blobs={},this._channel=new BroadcastChannel("bus.channel"),this._setupBg()):this._is("cs")?await this._setupCs():this._is("nj")?this._setupNj():this._is("os")?(t.setIframe=e=>this._iframe=e,this._iframe=null,this._channel=new BroadcastChannel("bus.channel"),this._setupOs()):this._is("oi")&&this._setupOi()},on(e,t,s=null){this._on(e,null,t,s)},off(e,t=null){this._off(e,null,t)},once(e,t){const s=async(...r)=>(this.off(e,s),await t(...r));this.on(e,s)},async send(e,...s){if(n.is.numeric(e)){const t=Number(e);return e=s[0],s=s.slice(1),await this._pick([this._sendToCs(t,e,...s),this._sendToExt(t,e,...s)])}if(this._is("pp"))return await this._sendToExt(e,...s);if(this._is("nj"))return await this._sendToPage(e,...s);if(this._is("oi"))return await this._sendToParent(e,...s);if(this._is("bg","cs","os"))return await this._pick([this._sendToExt(e,...s),this._callHandlers({name:e,args:s},(e=>e.proxy))]);if(this._is("fg")){if("store.actions"===e)return;if("idb.change"===e)return;t.log(e,...s)}},async call(e,...t){return this._callHandlers({name:e,args:t},(e=>!e.proxy))},async poll(e,...t){return await n.waitFor((()=>this.send(e,...t)))},async getTabId(){if(this._is("bg"))return null;if(this._is("pp")){const e=new o(u.href).searchParams.get("tabId");if(e)return Number(e)}const{tabId:e}=await this.send("bus.getTabData");return e},_on(e,t,s,r=null){this._handlers[e]||(this._handlers[e]=[]),this._is("cs","nj","oi")&&0===this._handlers[e].length&&this._sendToProxier("bus.proxy",e,!0);const n={fn:s,name:e};t&&(n.proxy=t),r&&(n.this=r),this._handlers[e].push(n)},_off(e,t=null,s=null){this._handlers[e]&&(this._handlers[e]=this._handlers[e].filter((e=>{const r=!s||s===e.fn,n=t===(e.proxy||null);return!r||!n})),0===this._handlers[e].length&&(delete this._handlers[e],this._is("cs","nj","oi")&&this._sendToProxier("bus.proxy",e,!1)))},_setupPp(){},_setupBg(){},async _setupCs(){},_setupNj(){let e=r.__$bus_njOnMsg__;e&&r.removeEventListener("message",e),e=async({data:e})=>{if(!this._isBusMsg(e))return;if("cs"!==e.locus)return;const t=await this._callHandlers(e);r.postMessage({resId:e.reqId,result:t},"*")},r.addEventListener("message",e),r.__$bus_njOnMsg__=e},_setupOs(){},_setupOi(){},async _sendToExt(e,...s){let r=null;n.is.numeric(e)&&(r=Number(e),e=s[0],s=s.slice(1));const i=this._serialize(s),a=this._createBusMsg({name:e,argsStr:i,target:r}),o=await new Promise((e=>{try{l.runtime.sendMessage(a,(t=>{l.runtime.lastError?e(null):e(t)}))}catch(s){if("Extension context invalidated."===s.message)return;t.error(s),e(null)}}));return await this._deserialize(o)},async _sendToCs(e,t,...s){if(!l.tabs?.sendMessage)return await this.send("bus.sendToCs",e,t,...s);const r=this._serialize(s),n=this._createBusMsg({name:t,argsStr:r,target:"cs"}),i=await new Promise((t=>{l.tabs.sendMessage(e,n,(e=>{l.runtime.lastError?t(null):t(e)}))}));return await this._deserialize(i)},async _sendToPage(e,...t){const s=this._generateId(),n=this._createBusMsg({name:e,args:t,reqId:s,locus:this._locus});return r.postMessage(n,"*"),await this._waitForResponseMessage(s)},async _sendToIframe(e,...t){if(!this._iframe)return null;const s=this._generateId(),r=this._createBusMsg({name:e,args:t,reqId:s});return this._iframe.contentWindow.postMessage(r,"*"),await this._waitForResponseMessage(s)},async _sendToParent(e,...t){const s=this._generateId(),r=this._createBusMsg({name:e,args:t,reqId:s});return _.postMessage(r,"*"),await this._waitForResponseMessage(s)},async _sendToProxier(e,...t){return this._is("cs")?await this._sendToExt(e,...t):this._is("nj")?await this._sendToPage(e,...t):this._is("oi")?await this._sendToParent(e,...t):void 0},_waitForResponseMessage:async e=>await new Promise((t=>{const s=({data:n})=>{!(!n||n.resId!==e)&&(r.removeEventListener("message",s),t(n.result))};r.addEventListener("message",s)})),_callHandlers({name:e,args:s,argsStr:r},n=null){let i=this._handlers[e];return i?(n&&(i=i.filter(n)),0===i.length?null:new Promise((async e=>{r&&(s=await this._deserialize(r));e(await this._pick(i.map((async e=>{try{return await e.fn.call(e.this,...s)}catch(s){return t.error(`failed to handle "${e.name}".`,s),s}}))))}))):null},_removeProxyHandlers(e){Object.keys(this._handlers).forEach((t=>{this._handlers[t]=this._handlers[t].filter((t=>t.proxy!==e)),0===this._handlers[t].length&&delete this._handlers[t]}))},_serialize(e){return n.is.nil(e)?null:JSON.stringify(e,((e,t)=>{if(n.is.blob(t)){if(this._is("bg")){const e=this._generateId();return this._blobs[e]=t,`bus.blob.${e}`}return`bus.blob.${n.objectUrl.create(t,!0)}`}return n.is.error(t)?`bus.error.${t.message}`:t}))},async _deserialize(e){if(!n.is.string(e))return null;const t=new Map,s=JSON.parse(e,((e,s)=>{const r=n.is.string(s);return r&&s.startsWith("bus.blob.")?(t.set(s,s.slice("bus.blob.".length)),s):r&&s.startsWith("bus.error.")?new Error(s.slice("bus.error.".length)):s}));return await Promise.all([...t.keys()].map((async e=>{let s;const r=t.get(e);s=r.startsWith("blob:")?r:await this._sendToExt("bus.blobIdToObjectUrl",r);const n=await c(s).then((e=>e.blob()));t.set(e,n)}))),this._applyBlobs(s,t)},_applyBlobs(e,t){if(t.has(e))return t.get(e);if(n.is.array(e)||n.is.object(e))for(const s in e)e[s]=this._applyBlobs(e[s],t);return e},async _blobIdToObjectUrl(e){},async _blobToObjectUrl(e){},_is(...e){return e.includes(this._locus)},_isBusMsg:t=>t&&t.$bus&&t.appName===e.name,_createBusMsg:t=>({$bus:!0,appName:e.name,...t}),_generateId:()=>`bus-${Date.now()}-${Math.random().toString(36).slice(2)}`,_wrapThrowIfError(e){return async(...t)=>{const s=await e.call(this,...t);if(n.is.error(s))throw s;return s}},_pick:async(e=[])=>0===e.length?null:await new Promise((t=>{let s=0;e.forEach((async r=>{const i=await r;return n.is.nil(i)?s===e.length-1?t(null):void s++:t(i)}))}))}})(),(()=>{const{$utils:t}=e;t.createPromise=()=>{let e=null,t=null;const s=new Promise(((s,r)=>{e=s,t=r}));return Object.defineProperty(s,"resolve",{get:()=>e}),Object.defineProperty(s,"reject",{get:()=>t}),s}})(),(()=>{const{$utils:t}=e;t.isTopFrame=()=>globalThis.top===globalThis})(),(()=>{const{$utils:t}=e;t.is={null:e=>null===e,defined:e=>void 0!==e,undefined:e=>void 0===e,nil:e=>null==e,boolean:e=>"boolean"==typeof e,number:e=>"number"==typeof e,string:e=>"string"==typeof e,symbol:e=>"symbol"==typeof e,function:e=>"function"==typeof e,map:e=>e instanceof Map,set:e=>e instanceof Set,url:e=>e instanceof o,blob:e=>e instanceof i,file:e=>e instanceof a,error:e=>e instanceof Error,regexp:e=>e instanceof RegExp,array:e=>Array.isArray(e),object:e=>"[object Object]"===Object.prototype.toString.call(e),nan:e=>Number.isNaN(e),nonPrimitive:e=>t.is.object(e)||t.is.array(e),numeric:e=>!t.is.nan(Number(e)),empty:e=>!!t.is.nil(e)||(t.is.array(e)?0===e.length:t.is.object(e)?0===Object.keys(e).length:!!t.is.string(e)&&0===e.trim().length)}})(),(()=>{const{$utils:t,$bus:s}=e;t.objectUrl={create(e,r=!1){if(!o.createObjectURL)return s.send("utils.objectUrl.create",e,r);const n=o.createObjectURL(e);if(r){const e=t.is.number(r)?r:6e4;d((()=>o.revokeObjectURL(n)),e)}return n},revoke(e){if(!o.revokeObjectURL)return s.send("utils.objectUrl.revoke",e);o.revokeObjectURL(e)}}})(),Array.prototype.toReversed&&(Array.prototype.toReversed=function(){return[...this].reverse()}),Array.prototype.at||(Array.prototype.at=function(e){return this[e>=0?e:this.length+e]}),Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(e,t){for(let s=this.length-1;s>=0;s--)if(e.call(t,this[s],s,this))return s;return-1}),(()=>{const{$utils:t}=e;t.sleep=async e=>new Promise((t=>{d(t,e)}))})(),(()=>{const{$utils:t}=e;t.waitFor=async(e,{interval:s=100,timeout:r=6e4}={})=>{if(r<=0)throw new Error("$utils.waitFor: timeout exceeded");const n=Date.now(),i=await e();if(i)return i;await t.sleep(s);const a=Date.now()-n;return t.waitFor(e,{interval:s,timeout:r-a})}})(),(()=>{const{$env:t}=e;t.getLocus=()=>{const{protocol:e,host:t,pathname:s,href:r}=u;return"https://harpa.ai/oi"===r||"http://localhost:3000/oi"===r||"http://localhost:3010/oi"===r?"oi":"chrome-extension:"!==e&&l?.runtime?.getURL?"cs":"localhost:3050"===t?"fg":"chrome-extension:"!==e?"nj":"/harpa.html"===s?"pp":"/offscreen.html"===s?"os":"bg"}})(),(()=>{const{$startup:t,$bus:s,$utils:r}=e;t.controller={async init(){this._root=h.querySelector("__hrp__"),this._initPromise=r.createPromise(),await s.controller.init(),this._initPromise.resolve(),t.logDev("nj ready")},async waitInit(){await this._initPromise},getRootElement(){return this._root}},t.controller.init()})()})();