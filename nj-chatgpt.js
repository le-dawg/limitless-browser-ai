(()=>{let t;(()=>{const e="__app_hrp",n="production",i=!1;if(t=globalThis[e],t)return;const r={name:e,env:n,get:t=>t in r?r[t]:null,...JSON.parse('{"version":"11.4.0"}')},o=function t(e){const n=e===r,s=n&&i,o={},d=t=>Object.assign(e,t),c=new Proxy(e,{get(i,r){if("assign"===r)return d;if(n&&!String(r).startsWith("$"))return e[r];if(!(r in e)){if(e[r]={},n){const t=a.bind(null,"log",r,!1),n=a.bind(null,"log",r,!0),i=a.bind(null,"warn",r,!1),s=a.bind(null,"warn",r,!0),o=a.bind(null,"error",r,!1),d=a.bind(null,"error",r,!0),c=l.bind(null,r);Object.defineProperties(e[r],{log:{get:()=>t},logDev:{get:()=>n},warn:{get:()=>i},warnDev:{get:()=>s},error:{get:()=>o},errorDev:{get:()=>d},Error:{get:()=>c}})}o[r]=t(e[r]),s&&(globalThis[r]=e[r])}return r in o?o[r]:e[r]},set:(t,n,i)=>(e[n]=i,o[n]=i,s&&(globalThis[n]=e[n]),!0)});return c}(r);function a(t,e,n,...i){if(n)return;const[r,o,a]=function(t){let e=0;t.split("").forEach(((n,i)=>{e=t.charCodeAt(i)+((e<<5)-e)}));return[(16711680&e)>>16,(65280&e)>>8,255&e]}(e);s[t](`%c[${e}]`,`color: rgb(${r}, ${o}, ${a})`,...i)}function l(t,e,...n){return n.length>0&&a("error",t,!1,e,...n),new Error(`[${t}] ${e}`)}globalThis[e]=o,t=o})();const e=t=>{const e=globalThis.__hrp_globals||{},n={},i=(t,e)=>"function"==typeof e&&/^[a-z]/.test(t);return new Proxy(t,{get(r,s){let o=e[s]||t[s];return i(s,o)&&(n[s]??=o.bind(t),o=n[s]),o},set:(e,r,s)=>(t[r]=s,i(r,s)&&(n[r]=s.bind(t)),!0)})},n=t=>{try{return i[t]}catch{return globalThis[t]}},i=e(globalThis),r=globalThis.top===globalThis?i:e(globalThis.top),s=n("logger")||n("console"),o=(n("Audio"),n("Blob")),a=(n("CSSStyleSheet"),n("CanvasRenderingContext2D"),n("CustomEvent"),n("DOMParser"),n("Event")),l=n("File"),d=(n("FileReader"),n("HTMLAnchorElement"),n("HTMLElement"),n("HTMLImageElement"),n("HTMLVideoElement"),n("Headers"),n("Image"),n("IntersectionObserver"),n("MouseEvent"),n("MutationObserver")),c=n("Node"),h=(n("NodeFilter"),n("NodeList"),n("Request"),n("ResizeObserver"),n("Response"),n("SVGElement"),n("URL")),p=(n("WebSocket"),n("Worker"),n("XMLHttpRequest"),n("XMLSerializer"),n("XPathResult"),n("alert"),n("atob"),n("btoa"),n("chrome"),n("clearInterval")),u=n("clearTimeout"),m=n("document"),g=(n("fetch"),n("getComputedStyle"),n("getSelection"),n("history"),n("indexedDB"),n("location"),n("navigator"),n("parent"),n("requestAnimationFrame"),n("screen"),n("setInterval")),b=n("setTimeout");let _=null;try{_=n("localStorage")}catch{}let v=null;try{v=n("sessionStorage")}catch{}(()=>{const{$chatgpt:e,$bus:n}=t;if(!m.getElementById("harpa-context-spinner-styles")){const t=m.createElement("style");t.id="harpa-context-spinner-styles",t.textContent="\n        @keyframes harpa-context-spin {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        .harpa-context-spinner {\n          animation: harpa-context-spin 1s linear infinite;\n        }\n      ",m.head.appendChild(t)}const s={dropdown:{rowHeight:36,visibleRows:5,verticalPadding:12,width:300,headerHeight:20,get height(){return this.rowHeight*this.visibleRows+this.verticalPadding}},selectors:{footerActions:'[data-testid="composer-footer-actions"]',trailingActions:'form[data-type="unified-composer"] div[class*="[grid-area:trailing]"]',fileInput:'input[type="file"]',fileListRoot:"[data-fullbleed]",uploadedFiles:".font-semibold"},classes:{dropdown:{background:"bg-token-main-surface-primary",hover:"hover:bg-[var(--menu-item-highlighted)]",textPrimary:"text-token-text-primary",textSecondary:"text-token-text-secondary",textTertiary:"text-token-text-tertiary"},menuItem:"__menu-item",tabUploaded:"__tab-uploaded",fileIcon:"__file-icon"},colors:{light:{uploadedText:"currentColor"},dark:{uploadedText:"currentColor"}},timing:{retryInterval:1e3,maxRetries:15,fileIconUpdateInterval:1e3,animationDuration:300,uploadStateTimeout:1e3},file:{maxTitleLength:15,type:"text/plain",extension:".txt"}},_={file:'<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon"><path d="M15.4835 4.14551C15.6794 3.85999 16.069 3.78747 16.3545 3.9834C16.6401 4.17933 16.7126 4.56897 16.5167 4.85449L8.9688 15.8545C8.86289 16.0088 8.69334 16.1085 8.50689 16.125C8.32053 16.1415 8.13628 16.0737 8.00494 15.9404L3.55377 11.4219L4.00005 10.9824L4.44634 10.542L8.36431 14.5176L15.4835 4.14551ZM3.55962 10.5352C3.80622 10.2922 4.20328 10.2955 4.44634 10.542L3.55377 11.4219C3.31073 11.1752 3.31297 10.7782 3.55962 10.5352Z"></path></svg>',contextButton:'<svg  width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 13.5v-6m-3 3h6M7 18v2.335c0 .533 0 .8.11.937a.5.5 0 0 0 .39.188c.176 0 .384-.167.8-.5l2.385-1.908c.487-.39.731-.585 1.002-.724.241-.122.497-.212.762-.267.299-.061.61-.061 1.235-.061H16.2c1.68 0 2.52 0 3.162-.327a3 3 0 0 0 1.311-1.311C21 15.72 21 14.88 21 13.2V7.8c0-1.68 0-2.52-.327-3.162a3 3 0 0 0-1.311-1.311C18.72 3 17.88 3 16.2 3H7.8c-1.68 0-2.52 0-3.162.327a3 3 0 0 0-1.311 1.311C3 5.28 3 6.12 3 7.8V14c0 .93 0 1.395.102 1.777a3 3 0 0 0 2.122 2.12C5.605 18 6.07 18 7 18Z"/></svg>'};class v{static getUploadedFileNames(){const t=m.querySelector('form[data-type="unified-composer"]');if(!t)return[];const e=t.querySelector(".horizontal-scroll-fade-mask");if(!e)return[];const n=[".font-semibold",'[data-testid*="file"]',".text-token-text-primary.font-semibold",".font-medium",".font-bold"];let i=[];for(const t of n){const n=e.querySelectorAll(t),r=Array.from(n).map((t=>{const e=t.textContent.trim();if(e.includes(".txt")||e.length<50&&!e.includes("ChatGPT")&&!e.includes("mind")){return e.endsWith(".txt")?e.slice(0,-4):e}return null})).filter((t=>t&&t.length>0&&"file"!==t));r.length>0&&(i=[...i,...r])}return[...new Set(i)]}static isDarkTheme(){return m.documentElement.classList.contains("dark")}static filterTabs(t){return t.filter((t=>!t.url?.includes("chatgpt.com")&&(!t.url?.includes("chromewebstore.google.com")&&(!(!t.url?.startsWith("http://")&&!t.url?.startsWith("https://"))&&!(!t.title?.trim()||"New Tab"===t.title)))))}static tabsEqual(t,e){return t.id===e.id&&t.title===e.title&&t.url===e.url&&t.favIconUrl===e.favIconUrl&&t.active===e.active}}class f{constructor(){this.currentTheme=v.isDarkTheme(),this.observer=null}startObserving(t){this.observer=new d((()=>{const e=v.isDarkTheme();e!==this.currentTheme&&(this.currentTheme=e,t(e))})),this.observer.observe(m.documentElement,{attributes:!0,attributeFilter:["class"]})}stopObserving(){this.observer&&(this.observer.disconnect(),this.observer=null)}}class x{constructor(t){this.controller=t,this.dropdown=null,this.menuGroup=null,this.expandingUp=!1,this.scrollBlocker=null}create(t=[]){this.destroy();const e=this._createWrapper(),n=this._createContainer(),i=this._createHeader();if(n.appendChild(i),t.length>0){const t=m.createElement("div");t.setAttribute("role","group"),n.appendChild(t),this.menuGroup=t}else{const t=this._createEmptyMessage();n.appendChild(t)}return e.appendChild(n),this.dropdown=e,this._setupEvents(n),this._blockScrolling(),e}destroy(){this.dropdown&&(this.dropdown.remove(),this.dropdown=null),this.menuGroup=null,this._unblockScrolling()}position(t){if(!this.dropdown)return;const e=s.dropdown.headerHeight,n=(this.menuGroup?.children.length>0&&(this.menuGroup.children.length,s.dropdown.rowHeight,s.dropdown.verticalPadding),this.menuGroup?.children.length>0?s.dropdown.width:200);let r=t.left;const o=s.dropdown.height+e;if(this.expandingUp=t.bottom+8+o>i.innerHeight,r+n>i.innerWidth&&(r=i.innerWidth-n-16),r<16&&(r=16),this.expandingUp){this.dropdown.style.top="auto",this.dropdown.style.transform="none";const e=i.innerHeight-(t.top-4);this.dropdown.style.bottom=`${e}px`,this.dropdown.style.left=`${r}px`,this.dropdown.setAttribute("data-side","top")}else this.dropdown.style.bottom="auto",this.dropdown.style.top=`${t.bottom+4}px`,this.dropdown.style.left=`${r}px`,this.dropdown.style.transform="none",this.dropdown.setAttribute("data-side","bottom")}_createWrapper(){const t=m.createElement("div");return t.setAttribute("data-radix-popper-content-wrapper",""),t.setAttribute("dir","ltr"),t.style.cssText="position: fixed; left: 0px; top: 0px; min-width: max-content; will-change: transform; z-index: 50;",t}_createContainer(){const t=m.createElement("div");return t.setAttribute("data-side","bottom"),t.setAttribute("data-align","start"),t.setAttribute("role","menu"),t.setAttribute("aria-orientation","vertical"),t.setAttribute("data-state","open"),t.setAttribute("dir","ltr"),t.className="z-50 max-w-xs rounded-2xl popover bg-token-main-surface-primary dark:bg-token-main-surface-primary shadow-long will-change-[opacity,transform] radix-side-bottom:animate-slideUpAndFade radix-side-left:animate-slideRightAndFade radix-side-right:animate-slideLeftAndFade radix-side-top:animate-slideDownAndFade py-1 max-h-[var(--radix-dropdown-menu-content-available-height)] overflow-y-auto select-none",t.style.cssText=`outline: none; border: none; pointer-events: auto; max-height: ${s.dropdown.height}px; overflow-y: auto; padding: 8px 0 6px 0; width: ${s.dropdown.width}px;`,t.setAttribute("tabindex","-1"),t}_createHeader(){const t=m.createElement("div");return t.style.cssText="padding-left: 14px; font-size: 12px; padding-bottom: 4px; padding-top: 2px; opacity: 0.3; letter-spacing: 0.1em;",t.textContent="POWERED BY HARPA AI",t}_createEmptyMessage(){const t=m.createElement("div");return t.className="px-4 py-3 text-center text-sm text-token-text-secondary",t.textContent="No pages available",t}_setupEvents(t){}_blockScrolling(){if(this.scrollBlocker)return;const t=i.scrollX,e=i.scrollY;this.scrollBlocker=n=>{this.dropdown&&this.dropdown.contains(n.target)||i.scrollTo(t,e)},i.addEventListener("scroll",this.scrollBlocker,{passive:!1,capture:!0})}_unblockScrolling(){this.scrollBlocker&&(i.removeEventListener("scroll",this.scrollBlocker),this.scrollBlocker=null)}}class w{static _ensureInputContextManager(){e.inputContextManager&&"function"==typeof e.inputContextManager.isContextInInput||e.InputContextManager&&(e.inputContextManager=new e.InputContextManager)}static create(t,n,i){this._ensureInputContextManager();const r=v.getUploadedFileNames(),o=(t.title||"").slice(0,s.file.maxTitleLength).trim(),a=this._createMenuItem(t),l=r.some((e=>{const n=t.id.toString();if(e===`${o} ${n}`)return!0;if(e.includes(` ${n}`))return!0;const i=e.match(/ (\d+)$/)?.[1];return!(!i||!n.startsWith(i))})),d=!(!e.inputContextManager||"function"!=typeof e.inputContextManager.isContextInInput)&&e.inputContextManager.isContextInInput(t.title||""),c=l||d,h=this._createContentContainer(t);return a.appendChild(h),c&&this._addFileIcon(a,i),a.onclick=e=>n(e,t,a),a}static _createMenuItem(t){const e=m.createElement("div");return e.setAttribute("role","menuitemradio"),e.setAttribute("aria-checked","false"),e.setAttribute("tabindex","0"),e.className=`group ${s.classes.menuItem} hoverable`,e.setAttribute("data-state","unchecked"),e.setAttribute("data-orientation","vertical"),e.setAttribute("data-tab-id",t.id),e.setAttribute("data-tab-title",t.title||""),e.style.display="flex",e.style.alignItems="center",e.style.padding="6px 10px",e.style.cursor="pointer",e.style.minHeight=`${s.dropdown.rowHeight}px`,e}static _addFileIcon(t){const e=m.createElement("span");e.className=s.classes.fileIcon,e.style.display="inline-flex",e.style.alignItems="center",e.style.transition="opacity 0.18s",e.style.marginLeft="8px";const n=m.createElement("span");n.innerHTML=_.file,e.appendChild(n),t.appendChild(e),t.classList.add(s.classes.tabUploaded),t.setAttribute("data-color","selected")}static _createContentContainer(t){const e=m.createElement("div");e.className="flex min-w-0 items-center gap-1.5 flex-1";const n=m.createElement("div");n.className="flex items-center justify-center group-disabled:opacity-50 group-data-disabled:opacity-50 icon";const i=m.createElement("img");i.style.cssText="width: 16px; height: 16px;",i.src=t.favIconUrl||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23666"%3E%3Crect width="16" height="16" fill="%23ddd"/%3E%3C/svg%3E',i.onerror=()=>{i.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="%23666"%3E%3Crect width="16" height="16" fill="%23ddd"/%3E%3C/svg%3E'},n.appendChild(i);const r=m.createElement("div");r.className="flex min-w-0 grow items-center gap-2.5 ml-1";const s=m.createElement("div");return s.className="truncate",s.textContent=t.title||"Untitled",r.appendChild(s),e.appendChild(n),e.appendChild(r),e}static updateFileIcons(t,n){this._ensureInputContextManager();const i=v.getUploadedFileNames();t.querySelectorAll("[data-tab-id]").forEach((t=>{const r=t.getAttribute("data-tab-title")||"",o=t.getAttribute("data-tab-id")||"",a=r.slice(0,s.file.maxTitleLength).trim(),l=i.some((t=>{const e=o.toString();if(t===`${a} ${e}`)return!0;if(t.includes(` ${e}`))return!0;const n=t.match(/ (\d+)$/)?.[1];return!(!n||!e.startsWith(n))})),d=e.inputContextManager?.isContextInInput?.(r)||!1;if(l||d)t.classList.add(s.classes.tabUploaded),t.setAttribute("data-color","selected"),t.querySelector(`.${s.classes.fileIcon}`)||this._addFileIcon(t,n);else{t.classList.remove(s.classes.tabUploaded),t.removeAttribute("data-color");const e=t.querySelector(`.${s.classes.fileIcon}`);e&&e.remove()}}))}}class C{static removeUploadedFile(t,n){if(e.inputContextManager?.removeContextFromInput?.(t)||!1)return;const i=m.querySelector('form[data-type="unified-composer"]');if(!i)return void e.warn("[CHATGPT] Composer form not found");const r=i.querySelector(".horizontal-scroll-fade-mask");if(!r)return void e.warn("[CHATGPT] File list root not found within composer form");const o=Array.from(r.querySelectorAll(s.selectors.uploadedFiles)),a=(t||"").slice(0,s.file.maxTitleLength),l=n?.toString()||"",d=o.find((t=>{const e=t.textContent.trim(),n=e.endsWith(".txt")?e.slice(0,-4):e;return n===`${a} ${l}`||(!!n.includes(` ${l}`)||(n===a||n.startsWith(a)))}));if(d){const t=d.closest(".group");t?t.remove():e.warn("[CHATGPT] File container not found")}else e.warn("[CHATGPT] File div not found for title:",a)}static async uploadContent(t){const n=`${t.content}`,r=t.tabId||"notab",d=`${(t.title||"webpage").slice(0,20).trim()} ${r}${s.file.extension}`,c=new o([n],{type:"text/plain;charset=utf-8"}),h=new l([c],d,{type:"text/plain;charset=utf-8"}),p=m.querySelector(s.selectors.fileInput);if(!p)return e.warn("[CHATGPT] File input not found"),{success:!1,method:"none",tabId:r};const u=new DataTransfer;u.items.add(h),p.files=u.files;const g=new a("change",{bubbles:!0});p.dispatchEvent(g),p.value="";const _=d.slice(0,-4);if(!await e.fileUploadVerifier.verifyUpload(_,{timeout:2e3})){const i=v.getUploadedFileNames(),s=_.split(" ")[0];if(!i.some((t=>{const e=r.toString();return t.includes(` ${e}`)||t.endsWith(e)||t.includes(s)&&t.match(/\d{4,}/)}))){const i=m.querySelector('div[contenteditable="true"].ProseMirror')||m.querySelector('[contenteditable="true"]')||m.querySelector("textarea");if(!i)return e.warn("[CHATGPT] No input element found for fallback"),{success:!1,method:"none",tabId:r};await new Promise((t=>b(t,500)));const s=r.toString();if(v.getUploadedFileNames().some((t=>t.includes(` ${s}`))))return{success:!0,method:"file",tabId:r};const o=e.inputContextManager?.formatContextForInput?.(n,{title:t.title,url:t.url||"",tabId:t.tabId})||n;if(e.inputContextManager&&e.inputContextManager._setElementValue)e.inputContextManager._setElementValue(i,o);else if(void 0!==i.value)i.value=o,i.dispatchEvent(new a("input",{bubbles:!0}));else{const t=o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");i.innerHTML=t,i.dispatchEvent(new a("input",{bubbles:!0}))}return{success:!0,method:"input",tabId:r}}}return b((()=>{i.$chatgpt?.controller?._dropdownManager?.menuGroup&&w.updateFileIcons(i.$chatgpt.controller._dropdownManager.menuGroup,i.$chatgpt.controller._handleFileRemove.bind(i.$chatgpt.controller))}),500),{success:!0,method:"file",tabId:r}}static setUploadingState(t){t.style.opacity="0.6",t.style.pointerEvents="none",b((()=>{t.style.opacity="",t.style.pointerEvents=""}),s.timing.uploadStateTimeout)}}e.controller={_state:{observer:null,fileObserver:null,fileScanInterval:null,contextButton:null,clickOutsideHandler:null,resizeHandler:null,currentTabs:[],fileTrackingInterval:null,dropdownOpen:!1,uploadedTabs:new Map},_themeManager:null,_dropdownManager:null,init(){r.self===self&&(e.inputContextManager&&"function"==typeof e.inputContextManager.isContextInInput||e.InputContextManager&&(e.inputContextManager=new e.InputContextManager),this._themeManager=new f,this._dropdownManager=new x(this),this._bindEvents(),this._tryInjectButton(),this._setupVisibilityHandling(),this._setupRetryMechanism(),this._setupCleanup(),this._setupFileObserver())},async handleButtonClick(t){"show-dropdown"===t?await this._toggleContextDropdown():e.warn("[CHATGPT] Unknown action:",t)},handleTabsChanged(t){if(!t?.tabs||!this._dropdownManager.dropdown||!this._dropdownManager.menuGroup)return;const e=v.filterTabs(t.tabs);this._updateDropdownWithAnimation(e)},_bindEvents(){n.on("chatgpt.tabs-changed",this.handleTabsChanged.bind(this)),this._themeManager.startObserving((()=>{}))},_setupVisibilityHandling(){m.addEventListener("visibilitychange",this._handleVisibilityChange.bind(this)),m.hidden?this._stopObserver():this._startObserver()},_setupRetryMechanism(){let t=0;const e=g((()=>{t++>s.timing.maxRetries?p(e):this._tryInjectButton()}),s.timing.retryInterval)},_setupCleanup(){i.addEventListener("beforeunload",(()=>{this._hideDropdown(),n.off("chatgpt.tabs-changed",this.handleTabsChanged.bind(this)),this._themeManager.stopObserving(),this._state.disableTimeout&&(u(this._state.disableTimeout),this._state.disableTimeout=null),this._state.enableCheckInterval&&(p(this._state.enableCheckInterval),this._state.enableCheckInterval=null),this._state.fileObserver&&(this._state.fileObserver.disconnect(),this._state.fileObserver=null)}))},_tryInjectButton(){const t=m.querySelector(s.selectors.trailingActions);return!!t&&(t.__hrp_chatgpt_patched||(t.__hrp_chatgpt_patched=!0,this._injectContextButton(t)),!0)},_injectContextButton(t){this._stopObserver(),m.removeEventListener("visibilitychange",this._handleVisibilityChange.bind(this));const e=m.createElement("span");e.className="",e.setAttribute("data-state","closed"),e.style.position="relative";const n=m.createElement("button");n.type="button",n.className="composer-btn",n.style.marginRight="-4px",n.setAttribute("aria-label","HARPA Context Tools"),n.onmousedown=t=>{t.preventDefault(),this.handleButtonClick("show-dropdown")};const i=()=>{e.setAttribute("data-state","delayed-open"),this._createTooltip(e)},r=()=>{e.setAttribute("data-state","closed"),this._removeTooltip()};n.addEventListener("mouseenter",i),n.addEventListener("mouseleave",r),n.addEventListener("focus",i),n.addEventListener("blur",r);const s=m.createElement("div");s.innerHTML=_.contextButton;const o=s.firstElementChild;o.style.position="relative",o.style.top="0.5px",n.appendChild(o),e.appendChild(n),t.firstChild?t.insertBefore(e,t.firstChild):t.appendChild(e),this._state.contextButton=n,this._state.tooltipWrapper=e},_createTooltip(){this._removeTooltip();const t=this._state.contextButton.getBoundingClientRect(),e=t.left+t.width/2,n=t.bottom,i=m.createElement("div");i.setAttribute("data-radix-popper-content-wrapper",""),i.style.cssText="\n          position: fixed;\n          left: 0px;\n          top: 0px;\n          min-width: max-content;\n          --radix-popper-transform-origin: 50% 0px;\n          will-change: transform;\n          z-index: 50;\n        ";const r=m.createElement("div");r.setAttribute("data-side","bottom"),r.setAttribute("data-align","center"),r.setAttribute("data-state","delayed-open"),r.className="relative z-50 transition-opacity select-none px-2 py-1 rounded-lg overflow-hidden dark bg-black max-w-xs",r.style.cssText=`\n          --radix-tooltip-content-transform-origin: var(--radix-popper-transform-origin);\n          --radix-tooltip-content-available-width: var(--radix-popper-available-width);\n          --radix-tooltip-content-available-height: var(--radix-popper-available-height);\n          --radix-tooltip-trigger-width: ${t.width}px;\n          --radix-tooltip-trigger-height: ${t.height}px;\n        `;const s=m.createElement("div");s.className="flex items-center gap-1";const o=m.createElement("div"),a=m.createElement("div");a.className="text-token-text-primary text-xs font-semibold whitespace-pre-wrap text-center",a.textContent=this._state.contextButton?.disabled?"Content Loading...":"HARPA Context Tools",o.appendChild(a),s.appendChild(o),r.appendChild(s);const l=m.createElement("span");l.setAttribute("role","tooltip"),l.style.cssText="position: absolute; border: 0px; width: 1px; height: 1px; padding: 0px; margin: -1px; overflow: hidden; clip: rect(0px, 0px, 0px, 0px); white-space: nowrap; overflow-wrap: normal;",l.innerHTML=s.outerHTML,r.appendChild(l),i.appendChild(r),m.body.appendChild(i);const d=e-r.getBoundingClientRect().width/2;i.style.transform=`translate(${d}px, ${n+8}px)`,this._state.tooltip=i},_removeTooltip(){this._state.tooltip&&(this._state.tooltip.remove(),this._state.tooltip=null)},_disableContextButton(){if(!this._state.contextButton)return;this._state.contextButton.disabled=!0,this._state.contextButton.style.opacity="0.7",this._state.contextButton.style.cursor="not-allowed";const t=this._state.contextButton.querySelector("svg");if(t){this._state.originalIcon=t.cloneNode(!0);const e=m.createElement("div");e.innerHTML='\n            <svg class="harpa-context-spinner" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path opacity="0.3" d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2ZM10 16C6.68629 16 4 13.3137 4 10C4 6.68629 6.68629 4 10 4C13.3137 4 16 6.68629 16 10C16 13.3137 13.3137 16 10 16Z" fill="currentColor"/>\n              <path d="M10 2C10 2 10 2 10 2V4C10 4 10 4 10 4C13.3137 4 16 6.68629 16 10H18C18 5.58172 14.4183 2 10 2Z" fill="currentColor"/>\n            </svg>\n          ';const n=e.firstElementChild;n.style.position="relative",n.style.top="1px",t.replaceWith(n)}this._state.disableTimeout&&u(this._state.disableTimeout),this._state.enableCheckInterval&&p(this._state.enableCheckInterval);const e=this._state.lastClickedTabId;e?(this._state.enableCheckInterval=g((()=>{const t=v.getUploadedFileNames().join(" ").includes(e.toString()),n=m.querySelector('div[contenteditable="true"].ProseMirror')||m.querySelector("textarea"),i=(n&&(n.textContent||n.value)||"").includes(e.toString()),r=(m.body.textContent||"").includes(e.toString());(t||i||r)&&this._enableContextButton()}),100),this._state.disableTimeout=b((()=>{this._enableContextButton()}),8e3)):this._enableContextButton()},_enableContextButton(){if(this._state.enableCheckInterval&&(p(this._state.enableCheckInterval),this._state.enableCheckInterval=null),this._state.disableTimeout&&(u(this._state.disableTimeout),this._state.disableTimeout=null),this._state.contextButton&&(this._state.contextButton.disabled=!1,this._state.contextButton.style.opacity="",this._state.contextButton.style.cursor="",this._state.originalIcon)){const t=this._state.contextButton.querySelector(".harpa-context-spinner");t&&t.replaceWith(this._state.originalIcon),this._state.originalIcon=null}},async _toggleContextDropdown(){this._dropdownManager.dropdown?this._hideDropdown():await this._showContextDropdown()},async _showContextDropdown(){try{await n.send("chatgpt.test-background"),n.send("chatgpt.analytics.dropdown-opened","chatgpt-dropdown-opened");const t=await n.send("chatgpt.get-tabs");if(t?.tabs){const e=v.filterTabs(t.tabs);this._state.currentTabs=e;const n=this._dropdownManager.create(e);e.length>0&&this._dropdownManager.menuGroup&&this._renderTabsList(e),this._state.dropdownOpen=!0,this._positionDropdown(),this._setupDropdownEvents(),m.body.appendChild(n),this._startFileTracking()}}catch(t){}},_positionDropdown(){if(!this._dropdownManager.dropdown||!this._state.contextButton)return;const t=this._state.contextButton.getBoundingClientRect();this._dropdownManager.position(t)},_setupDropdownEvents(){this._state.clickOutsideHandler=t=>{this._dropdownManager.dropdown?.contains(t.target)||this._state.contextButton?.contains(t.target)||this._hideDropdown()},m.addEventListener("click",this._state.clickOutsideHandler),this._state.resizeHandler=()=>this._positionDropdown(),i.addEventListener("resize",this._state.resizeHandler)},_hideDropdown(){this._dropdownManager.destroy(),this._state.dropdownOpen=!1,this._stopFileTracking(),this._removeTooltip(),this._state.clickOutsideHandler&&(m.removeEventListener("click",this._state.clickOutsideHandler),this._state.clickOutsideHandler=null),this._state.resizeHandler&&(i.removeEventListener("resize",this._state.resizeHandler),this._state.resizeHandler=null),this._state.currentTabs=[]},_renderTabsList(t){this._dropdownManager.menuGroup&&(this._dropdownManager.menuGroup.innerHTML="",t.forEach((t=>{const e=w.create(t,this._handleTabClick.bind(this),this._handleFileRemove.bind(this));this._dropdownManager.menuGroup.appendChild(e)})))},async _handleTabClick(t,i,r){n.send("chatgpt.analytics.tab-clicked","chatgpt-tab-clicked",{tabDomain:new h(i.url||"").hostname}),r.blur();const o=v.getUploadedFileNames(),a=r.getAttribute("data-tab-title")||"",l=a.slice(0,s.file.maxTitleLength).trim(),d=o.some((t=>{const e=i.id.toString();if(t===`${l} ${e}`)return!0;if(t.includes(` ${e}`))return!0;const n=t.match(/ (\d+)$/)?.[1];return!(!n||!e.startsWith(n))})),c=e.inputContextManager?.isContextInInput?.(a)||!1;if(d||c)return this._hideDropdown(),C.removeUploadedFile(a,i.id),t.preventDefault(),void t.stopImmediatePropagation();this._hideDropdown(),this._state.lastClickedTabId=i.id,this._disableContextButton(),t.stopPropagation();try{const t=await n.send("chatgpt.get-page-content",Number(i.id));if(t?.error)e.warn("[CHATGPT] Error getting page content:",t.message);else if(t?.content){this._state.uploadedTabs.set(i.id.toString(),{title:i.title||"Untitled",favIconUrl:i.favIconUrl,url:i.url});const n={...t,tabId:i.id};C.uploadContent(n).then((t=>{t.success||e.error("[CHATGPT] Upload failed"),b((()=>{this._scanForExistingFiles()}),2e3)}))}else e.warn("[CHATGPT] No content received for tab",i.id)}catch(t){e.error("[CHATGPT] Error getting content:",t)}},_handleFileRemove(t,e){const n=e.getAttribute("data-tab-id");this._state.uploadedTabs.delete(n),C.removeUploadedFile(t,n),C.setUploadingState(e)},_startFileTracking(){this._state.fileTrackingInterval||(this._dropdownManager.menuGroup&&w.updateFileIcons(this._dropdownManager.menuGroup,this._handleFileRemove.bind(this)),this._state.fileTrackingInterval=g((()=>{this._dropdownManager.menuGroup&&w.updateFileIcons(this._dropdownManager.menuGroup,this._handleFileRemove.bind(this))}),s.timing.fileIconUpdateInterval))},_stopFileTracking(){this._state.fileTrackingInterval&&(p(this._state.fileTrackingInterval),this._state.fileTrackingInterval=null)},_updateDropdownWithAnimation(t){if(!this._dropdownManager.menuGroup)return;const e=new Map(this._state.currentTabs.map((t=>[t.id,t]))),n=new Map(t.map((t=>[t.id,t])));let i=!1;for(const t of e.keys())if(!n.has(t)){const e=this._dropdownManager.menuGroup.querySelector(`[data-tab-id="${t}"]`);e&&(this._animateTabRemoval(e),i=!0)}for(const[t,r]of n.entries()){const n=e.get(t),s=this._dropdownManager.menuGroup.querySelector(`[data-tab-id="${t}"]`);n||s?n&&s&&(v.tabsEqual(n,r)||(this._updateExistingTab(s,n,r),i=!0)):(this._animateTabAddition(r),i=!0)}this._state.currentTabs=t,i&&this._state.currentTabs.length!==e.size&&b((()=>this._positionDropdown()),s.timing.animationDuration)},_animateTabRemoval(t){t.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out",t.style.opacity="0",t.style.transform="translateX(-10px)",b((()=>{t.parentNode&&t.remove()}),200)},_animateTabAddition(t){if(!this._dropdownManager.menuGroup)return;if(this._dropdownManager.menuGroup.querySelector(`[data-tab-id="${t.id}"]`))return;const e=w.create(t,this._handleTabClick.bind(this),this._handleFileRemove.bind(this));e.style.opacity="0",e.style.transform="translateX(10px)",e.style.transition="opacity 0.3s ease-out, transform 0.3s ease-out",this._dropdownManager.menuGroup.appendChild(e),b((()=>{e.style.opacity="1",e.style.transform="translateX(0)"}),50)},_updateExistingTab(t,e,n){if(!v.tabsEqual(e,n)){if(e.title!==n.title){const e=t.querySelector(".truncate");e&&(e.textContent=n.title||"Untitled")}if(e.favIconUrl!==n.favIconUrl){const e=t.querySelector("img");e&&(e.src=n.favIconUrl||'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23666"%3E%3Crect width="20" height="20" fill="%23ddd"/%3E%3C/svg%3E')}e.url!==n.url&&t.setAttribute("data-tab-url",n.url||"")}},_startObserver(){this._state.observer||m.hidden||(this._state.observer=new d((t=>{t?.some((t=>t.addedNodes.length))&&this._tryInjectButton()})),this._state.observer.observe(m.documentElement,{childList:!0,subtree:!0}))},_stopObserver(){this._state.observer&&(this._state.observer.disconnect(),this._state.observer=null)},_handleVisibilityChange(){m.hidden?this._stopObserver():this._startObserver()},_setupFileObserver(){const t=m.querySelector('form[data-type="unified-composer"]');if(!t)return void b((()=>this._setupFileObserver()),1e3);const e=t.querySelector(".horizontal-scroll-fade-mask");e?(this._state.fileObserver=new d((t=>{t.forEach((t=>{t.addedNodes.forEach((t=>{t.nodeType===c.ELEMENT_NODE&&this._processNewFileElement(t)}))}))})),this._state.fileObserver.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]}),this._scanForExistingFiles()):b((()=>this._setupFileObserver()),1e3)},_processNewFileElement(t){t.querySelector&&t.querySelector(".font-semibold")&&this._scanForExistingFiles()},_scanForExistingFiles(){const t=m.querySelector('form[data-type="unified-composer"]');if(!t)return;t.querySelectorAll(".horizontal-scroll-fade-mask .group.text-token-text-primary.relative.inline-block").forEach((t=>{const e=t.querySelector(".font-semibold");if(!e)return;const n=e.textContent?.trim();if(!n?.endsWith(".txt"))return;const i=n.match(/ (\d+)\.txt$/);if(!i)return;const r=i[1],s=this._state.uploadedTabs.get(r);s&&!t.hasAttribute("data-harpa-customized")&&this._customizeUploadedFile(t,e,s)}))},_customizeUploadedFile(t,e,n){t.setAttribute("data-harpa-customized","true");const i=t.querySelector(".relative.h-10.w-10.shrink-0.overflow-hidden.rounded-lg"),r=t.querySelector(".text-token-text-secondary.truncate");if(!i||!r)return;const s=e.textContent.trim().replace(/\.txt$/,"");e.textContent=s,r.textContent="Tab Context by HARPA";const o=g((()=>{if(i.querySelector('div[style*="background-color"]')&&n.favIconUrl){if(i.querySelector("img[data-harpa-favicon]"))return void p(o);p(o);const t=m.createElement("img");t.src=n.favIconUrl,t.className="h-10 w-10 shrink-0 rounded-lg object-cover",t.style.cssText="width: 40px; height: 40px;",t.setAttribute("data-harpa-favicon","true"),t.onerror=()=>{t.remove()},i.appendChild(t)}}),100);b((()=>p(o)),5e3)}}})(),(()=>{const{$startup:e,$chatgpt:n}=t;e.chatgptController={async init(){await e.controller.waitInit(),await n.controller.init(),e.logDev("nj-chatgpt ready")}},e.chatgptController.init()})(),(()=>{const{$chatgpt:e}=t;e.fileUploadVerifier=new class{constructor(){this.uploadPromises=new Map,this.observer=null,this.uploadTimeout=1e4,this.checkInterval=500}async verifyUpload(t,e={}){const n=e.timeout||this.uploadTimeout,i=this._cleanFileName(t);if(this.uploadPromises.has(i))return this.uploadPromises.get(i).promise;const r=this._createUploadPromise(i,n);return this.uploadPromises.set(i,r),this.observer||this._startObserver(),this._startPeriodicCheck(i),r.promise}isFileUploaded(t){const e=this._cleanFileName(t);return this._getUploadedFiles().some((t=>this._normalizeFileName(t)===this._normalizeFileName(e)))}getUploadedFiles(){return this._getUploadedFiles()}stopMonitoring(t){const e=this._cleanFileName(t),n=this.uploadPromises.get(e);n&&(n.intervalId&&p(n.intervalId),this.uploadPromises.delete(e)),0===this.uploadPromises.size&&this.observer&&this._stopObserver()}cleanup(){for(const t of this.uploadPromises.values())t.intervalId&&p(t.intervalId);this.uploadPromises.clear(),this._stopObserver()}_createUploadPromise(t,e){let n,i;const r=new Promise(((t,e)=>{n=t,i=e})),s=b((()=>{this.stopMonitoring(t),n(!1)}),e);return{promise:r,resolve:n,reject:i,startTime:Date.now(),timeoutId:s,intervalId:null}}_startObserver(){this.observer||(this.observer=new d((()=>{for(const[t,e]of this.uploadPromises)this.isFileUploaded(t)&&(u(e.timeoutId),p(e.intervalId),e.resolve(!0),this.uploadPromises.delete(t));0===this.uploadPromises.size&&this._stopObserver()})),this.observer.observe(m.body,{childList:!0,subtree:!0,characterData:!0}))}_stopObserver(){this.observer&&(this.observer.disconnect(),this.observer=null)}_startPeriodicCheck(t){const e=this.uploadPromises.get(t);if(e)return this.isFileUploaded(t)?(u(e.timeoutId),e.resolve(!0),void this.uploadPromises.delete(t)):void(e.intervalId=g((()=>{this.isFileUploaded(t)&&(u(e.timeoutId),p(e.intervalId),e.resolve(!0),this.uploadPromises.delete(t))}),this.checkInterval))}_getUploadedFiles(){const t=m.querySelector('form[data-type="unified-composer"] .horizontal-scroll-fade-mask');if(!t)return[];const e=t.querySelectorAll(".font-semibold"),n=new Set;return e.forEach((t=>{const e=t.textContent.trim();this._looksLikeFileName(e)&&n.add(this._cleanFileName(e))})),Array.from(n)}_looksLikeFileName(t){return!(!t||0===t.length)&&("file"!==t&&(!!t.includes(".txt")||t.length<50&&!t.includes("ChatGPT")&&!t.includes("mind")))}_cleanFileName(t){return t?t.endsWith(".txt")?t.slice(0,-4):t:""}_normalizeFileName(t){return t.toLowerCase().trim().replace(/[^\w\s-]/g,"")}}})(),(()=>{const{$chatgpt:e}=t;e.InputContextManager=class{constructor(){this.contextPattern=/\[CONTEXT-START:([^:]+):([^\]]+)\]([\s\S]*?)\[CONTEXT-END:\1:\2\]/g,this.contextStartPattern=/\[CONTEXT-START:([^:]+):([^\]]+)\]/,this.contextEndPattern=/\[CONTEXT-END:([^:]+):([^\]]+)\]/,this._inputElementCache=null,this._lastInputCheck=0}formatContextForInput(t,e){const n=this._sanitizeTitle(e.title||"webpage"),i=e.tabId||this._generateUrlHash(e.url||""),r=this._getCurrentInputValue(),s=`[CONTEXT-START:${n}:${i}]\n${t}\n[CONTEXT-END:${n}:${i}]`;return r&&r.trim()?`${r}\n\n${s}`:`\n\n${s}`}isContextInInput(t){const e=this._getCurrentInputValue();if(!e)return!1;const n=this._sanitizeTitle(t);return new RegExp(`\\[CONTEXT-START:${this._escapeRegex(n)}:[^\\]]+\\]`,"i").test(e)}removeContextFromInput(t){const e=this._getInputElement();if(!e)return!1;const n=this._getElementValue(e);if(!n)return!1;const i=this._sanitizeTitle(t),r=new RegExp(`\\[CONTEXT-START:${this._escapeRegex(i)}:([^\\]]+)\\][\\s\\S]*?\\[CONTEXT-END:${this._escapeRegex(i)}:\\1\\]`,"g");let s=n.replace(r,"");return s=this._cleanupNewlines(s),this._setElementValue(e,s),n!==s}getContextCount(){const t=this._getInputElement();if(!t)return 0;const e=this._getElementValue(t);if(!e)return 0;const n=e.match(this.contextPattern);return n?n.length:0}extractUserText(t){if(!t)return"";let e=t.replace(this.contextPattern,"");return this._cleanupNewlines(e)}getContextsInInput(){const t=this._getCurrentInputValue();if(!t)return[];const e=[];let n;for(this.contextPattern.lastIndex=0;null!==(n=this.contextPattern.exec(t));)e.push({title:n[1],hash:n[2],content:n[3].trim()});return e}hasAnyContext(){const t=this._getCurrentInputValue();return!!t&&this.contextStartPattern.test(t)}_getCurrentInputValue(){const t=this._getInputElement();return t?this._getElementValue(t):""}_getInputElement(){const t=Date.now();return(t-this._lastInputCheck>500||!this._inputElementCache)&&(this._inputElementCache=m.querySelector('div[contenteditable="true"].ProseMirror')||m.querySelector('[contenteditable="true"]')||m.querySelector('textarea[placeholder*="Ask"]')||m.querySelector("textarea"),this._lastInputCheck=t),this._inputElementCache}_getElementValue(t){if(void 0!==t.value)return t.value;{const e=m.createElement("div");return e.innerHTML=t.innerHTML,e.innerHTML=e.innerHTML.replace(/<br\s*\/?>/gi,"\n"),e.textContent||""}}_setElementValue(t,e){if(void 0!==t.value)t.value=e,t.dispatchEvent(new a("input",{bubbles:!0}));else{const n=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");t.innerHTML=n,t.dispatchEvent(new a("input",{bubbles:!0}))}}_sanitizeTitle(t){return t.replace(/[:\[\]]/g,"_").slice(0,50).trim()}_generateUrlHash(t){if(!t)return"no-url";let e=0;for(let n=0;n<t.length;n++){e=(e<<5)-e+t.charCodeAt(n),e&=e}return Math.abs(e).toString(16).substring(0,8)}_escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}_cleanupNewlines(t){return(t=(t=t.trim()).replace(/\n{3,}/g,"\n\n"))?t=t.replace(/^\n+/,"\n\n"):""}}})()})();