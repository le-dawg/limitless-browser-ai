(()=>{let t;(()=>{const e="__app_hrp",i="production",s=!1;if(t=globalThis[e],t)return;const n={name:e,env:i,get:t=>t in n?n[t]:null,...JSON.parse('{"version":"11.4.0"}')},r=function t(e){const i=e===n,r=i&&s,c={},l=t=>Object.assign(e,t),h=new Proxy(e,{get(s,n){if("assign"===n)return l;if(i&&!String(n).startsWith("$"))return e[n];if(!(n in e)){if(e[n]={},i){const t=o.bind(null,"log",n,!1),i=o.bind(null,"log",n,!0),s=o.bind(null,"warn",n,!1),r=o.bind(null,"warn",n,!0),c=o.bind(null,"error",n,!1),l=o.bind(null,"error",n,!0),h=a.bind(null,n);Object.defineProperties(e[n],{log:{get:()=>t},logDev:{get:()=>i},warn:{get:()=>s},warnDev:{get:()=>r},error:{get:()=>c},errorDev:{get:()=>l},Error:{get:()=>h}})}c[n]=t(e[n]),r&&(globalThis[n]=e[n])}return n in c?c[n]:e[n]},set:(t,i,s)=>(e[i]=s,c[i]=s,r&&(globalThis[i]=e[i]),!0)});return h}(n);function o(t,e,i,...s){if(i)return;const[n,r,o]=function(t){let e=0;t.split("").forEach(((i,s)=>{e=t.charCodeAt(s)+((e<<5)-e)}));return[(16711680&e)>>16,(65280&e)>>8,255&e]}(e);console[t](`%c[${e}]`,`color: rgb(${n}, ${r}, ${o})`,...s)}function a(t,e,...i){return i.length>0&&o("error",t,!1,e,...i),new Error(`[${t}] ${e}`)}globalThis[e]=r,t=r})(),(()=>{const{$engine:e,$utils:i}=t;e.controller={init(){const t="engine-0.1.0";this.connectionPromise=i.createPromise();let s=null;const n=window.frameElement?.getAttribute("__hrp")||window.location.href?.match(/[?&#]__hrp=(?<name>([a-zA-Z\d\-._]*:?){6})/)?.groups?.name||window.name,r=t=>{s||(s=e.injector().inject(t))};(()=>{window.top===window&&chrome.runtime.onMessage.addListener((async(t,e,i)=>{if("request"===t.type){if("ping"===t.command)return i("pong"),!0;if("connect"===t.command)return s?(await this.connectionPromise,void top.postMessage({type:"connected",frameName:s.config.frameName},"*")):void r(t.config);await this.connectionPromise,s&&t.frameName===s.config.frameName&&window.postMessage(t,"*")}}))})();let o=null;try{o=JSON.parse(atob(n))}catch{}(e=>!!e?.frameName?.startsWith(t))(o)?r(o):chrome.runtime.sendMessage({type:"should-connect",engineName:t},(t=>{!chrome.runtime.lastError&&t&&r(t)}))}}})(),(()=>{const{$engine:e,$startup:i,$bus:s}=t;e.injector=()=>({inject(t){if(this.config=this._parseConfig(t),this.config&&this.config.frameName){this._root=i.controller.ensureRootElement();try{localStorage.setItem("__hrp.config",JSON.stringify(this.config))}catch{}return this._propagateEvents(this.config),this.config.noPatches||(this._insertStealth(this.config),this._insertPatches(this.config)),this._insertInjection(),this}},_parseConfig(t){try{return t={beforeLoad:["patch-console","no-content-visibility","no-prompt","no-notification","no-request-fullscreen","force-visible","shim-raf","no-transitions","patch-intersection-observer"],afterLoad:[],stealth:!0,waitForDocumentBody:!0,waitForDocumentReady:!0,...t,configString:btoa(JSON.stringify(t))},this._constructNavigator(t),t}catch(t){return console.error(t),null}},_constructNavigator(t){if(t.vua){const e={"macbook-13.4":{userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36",platform:"MacIntel"},"windows-pc":{userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36",platform:"Win32"},"galaxy-s5":{userAgent:"Mozilla/5.0 (Linux; Android 5.0; SM-G900P Build/LRX21T) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Mobile Safari/537.36",platform:"Android"},"iphone-x":{userAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.5 Mobile/15E148 Safari/604.1",platform:"iPhone",vendor:"Apple Computer, Inc."}}[t.vua];e&&(t.navigator={...e,appVersion:e.userAgent.slice(8),vendor:e.vendor||"Google Inc.",webdriver:!1,productSub:"20030107"})}if(t.vlang){const e=t.vlang.replace("_","-");t.navigator={...t.navigator,language:e,languages:[e]},e.includes("-")&&t.navigator.languages.push(e.split("-")[1])}},_propagateEvents(t){const i=async({data:n})=>{if(this._root?.isConnected){if(n)return n.frameName===t.frameName&&"connected"===n.type&&e.controller.connectionPromise.resolve(),n.frameName===t.frameName&&"execute"===n.type?(this._tabId??=await s.getTabId(),void await s.send("engine.executeJs",this._tabId,n.js)):n.frameName!==t.frameName||"request"===n.type||void await chrome.runtime.sendMessage(n)}else window.removeEventListener("message",i)};window.addEventListener("message",i)},_insertStealth(e){e.stealth&&"function"==typeof t.$stealth&&i.controller.executeJs(`(${t.$stealth.toString()})()`)},_insertPatches(t){const e=`(${(()=>{const t=CONFIG_PLACEHOLDER;navigator.config=t;const e=document.__lookupGetter__("visibilityState").bind(document),i=(t,e,i)=>{try{Object.defineProperty(t,e,i)}catch{}},s=t=>{const e=document.createElement("style");e.textContent=t;document.querySelector("__hrp__").append(e)},n={"patch-console"(){window.log=console.log},"no-content-visibility"(){s("* { content-visibility: visible !important; }")},"no-transitions"(){s("body, body * { transition-duration: 0s !important; transition-delay: 0s !important; animation-duration: 0s !important; animation-delay: 0s !important; }")},"no-prompt"(){window.prompt=()=>{}},"no-notification"(){"Notification"in window&&(i(window.Notification,"permission",{get:()=>"denied"}),i(window.Notification,"requestPermission",{value:t=>(t&&t("denied"),Promise.resolve("denied"))}))},"force-visible"(){const t=t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()},e=(t=!1)=>({get:()=>t});i(document,"visibilityState",e("visible")),i(document,"hidden",e(!1)),i(document,"webkitHidden",e(!1)),document.__proto__.hasFocus=()=>!0,document.addEventListener("blur",t,!0),window.addEventListener("blur",t,!0),window.addEventListener("pagehide",t,!0),window.addEventListener("load",(()=>{document.body.focus({preventScroll:!0}),document.dispatchEvent(new Event("visibilitychange"))}))},"shim-raf"(){let t=0;window.requestAnimationFrame=e=>{const i=window.performance.now(),s=Math.max(t+16,i);return setTimeout((()=>{e(t=s)}),s-i)},window.cancelAnimationFrame=t=>clearTimeout(t)},"no-request-fullscreen"(){window.addEventListener("DOMContentLoaded",(()=>{document.body.requestFullscreen=()=>{}}))},"patch-intersection-observer"(){if("visible"===e())return;let t=!0;document.addEventListener("visibilitychange",(()=>{t="hidden"===e()})),window.IntersectionObserver=class extends IntersectionObserver{constructor(...t){super(...t),this._cb=t[0].bind(this),this._timer=null,this._entries=[],this._viewport={x:0,y:0,top:0,left:0,right:window.innerWidth,width:window.innerWidth,bottom:Math.max(2100,window.innerHeight),height:Math.max(2100,window.innerHeight)}}observe(e){if(!t)return super.observe(...arguments);const i=e.getBoundingClientRect();this._entries.push({time:1e3,target:e,rootBounds:this._viewport,intersectionRect:i,boundingClientRect:i,isVisible:!0,intersectionRatio:1,isIntersecting:i.left<this._viewport.right&&i.right>this._viewport.left&&i.top<this._viewport.bottom&&i.bottom>this._viewport.top}),clearTimeout(this._timer),this._timer=setTimeout((()=>{this._cb(this._entries,this),this._entries=[]}),500)}unobserve(){if(!t)return super.unobserve(...arguments)}}}},r=t=>{for(const e of t){const t=n[e];t&&t()}};(()=>{if(t.navigator)for(const e in t.navigator){if(navigator[e]===t.navigator[e])continue;const i={get:()=>t.navigator[e]};try{Object.defineProperty(navigator,e,i)}catch(t){globalThis.navigator=Object.create(navigator,{[e]:i})}}})(),r(t.beforeLoad),window.onload=()=>r(t.afterLoad)}).toString()})()`.replace("CONFIG_PLACEHOLDER",JSON.stringify(t));i.controller.executeJs(e)},_insertInjection(){i.controller.insert("/nj-engine.js"),i.controller.insert("/nj-engine.css")}})})(),(()=>{const{$shortcut:e}=t;e.launchListener=t=>{e.launchListener.handler=e=>{s(e,t)},window.addEventListener("keydown",e.launchListener.handler)},e.launchListener.off=()=>window.removeEventListener("keydown",e.launchListener.handler);let i=[];const s=(t,e)=>{if(e.config?.qap?.enabledHotkeys&&!["Alt","Shift","Meta","Control"].includes(t.key)&&!(t.altKey||t.ctrlKey||t.metaKey)){if("Escape"===t.key)return i=[],e.deactivateQap(),!0;if(i.unshift(t.key),i.length>3&&i.pop(),":"===i[2])return!1;if("/"===i[0]&&"/"===i[1]&&!e.isActivated())return e.activateQap(),!0;if(e.isActivated()){const t=e.optionForHotkey(i[0]);if(t)return i=[],e.deactivateQap(),e.launchOption(t)}return!!e.isActivated()&&(i=[],e.deactivateQap(),!0)}}})(),(()=>{const{$shortcut:e,$bus:i}=t;e.Action=class{constructor(t,e,i){this.id=t,this.config=e,this.isEnabled=i}setup(){this._isApplicable()&&(this._cleanup(),this.isEnabled(this.id)&&this._createActionButton())}destroy(){this._isApplicable()&&(this.observer&&(this.observer.disconnect(),this.observer=null),this._cleanup())}_isApplicable(){const t=Array.isArray(this.config.urls)?this.config.urls:[this.config.urls],e=location.href;return t.some((t=>t.startsWith("RegExp=")?new RegExp(t.slice(7),"i").test(e):e.includes(t)))}_cleanup(){Array.from(document.querySelectorAll(`.hrp-action.${this.id}`)).forEach((t=>t.remove()))}_createActionButton(){const t=Symbol();this.observer=new MutationObserver((e=>{if(!e?.some((t=>t.addedNodes.length)))return;const i=document.querySelector(this.config.insertTarget);if(!i)return;if(i[t])return;if(i[t]=!0,i.parentElement?.querySelector(`.hrp-action.${this.id}`))return;this.config.observe||this.observer.disconnect(),i.insertAdjacentHTML(this.config.insertPosition||"beforebegin",this._renderSummaryButton());document.querySelector(`.hrp-action.${this.id}`).addEventListener("click",this._onClick.bind(this))})),this.observer.observe(document.documentElement,{childList:!0,subtree:!0})}async _onClick(){const t=await i.getTabId();this.config.hideFrame||await i.send("browser.showFrame",t),this.config.command&&await i.send("shortcut.executeCommand",t,{command:this.config.command,inputs:"function"==typeof this.config.inputs?this.config.inputs(this):this.config.inputs,clearChat:this.config.clearChat}),this.config.sendAnalytics&&await i.send("analytics.send",this.config.sendAnalytics)}_renderSummaryButton(){let t='<div class="hrp-action ID"><img src=IMG_SRC><div>NAME</div><style>.hrp-action.ID{display:flex;align-items:center;white-space:nowrap;gap:8px;width:fit-content;height:32px;padding:0 8px 0 8px;margin:MARGIN;font-size:14px!important;font-weight:500!important;line-height:36px;color:#fff;background:#282f33;border-radius:8px;cursor:pointer;transition:background .15s,filter .15s;user-select:none;z-index:9999}.hrp-action.ID>div{display:LABEL_DISPLAY;line-height:30px}.hrp-action.ID>img{display:IMG_DISPLAY;filter:invert(100%);margin:0!important}.hrp-action.ID:hover{filter:brightness(150%)}.hrp-action.ID:active{filter:brightness(90%);background:rgba(0,0,0,.15)}html[dark] .hrp-action.ID{color:#f1f1f1;background:rgba(255,255,255,.1)}html[dark] .hrp-action.ID:hover{filter:brightness(120%)}html[dark] .hrp-action.ID:active{filter:brightness(100%);background:rgba(255,255,255,.08)}</style></div>'.replaceAll("ID",this.id).replaceAll("NAME",this.config.label||"").replaceAll("LABEL_DISPLAY",this.config.label?"block":"none").replaceAll("MARGIN",this.config.margin||"0px").replaceAll("IMG_DISPLAY",this.config.icon?"block":"none").replaceAll("IMG_SRC",this.config.icon&&chrome.runtime.getURL(`/img/commands/${this.config.icon}.svg`)||"");if(this.config.style){const e=t.indexOf("</style>");t=t.slice(0,e)+this.config.style+t.slice(e)}return t}}})(),(()=>{const{$shortcut:e,$bus:i}=t;e.controller={async init(){e.hotkeyController.init(),this.destroyPreviousController(),this.actions=this.getActions(),await this.setupWhenVisible()},async setupWhenVisible(){"visible"===document.visibilityState?await this.setup():(this.onVisibilityChange=this.onVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.onVisibilityChange))},onVisibilityChange(){"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",this.onVisibilityChange),this.setup())},async setup(){this.config=await i.send("shortcut.getConfig"),this.onConfigUpdate=this.onConfigUpdate.bind(this),i.on("shortcut.configUpdate",this.onConfigUpdate),this.onConfigUpdate(this.config)},onConfigUpdate(t){this.config=t,e.interceptor.setup(t),this.actions&&this.actions.forEach((t=>t.setup()))},destroyPreviousController(){document.documentElement.dispatchEvent(new Event("hrp-shortcut-controller-destroy")),document.documentElement.addEventListener("hrp-shortcut-controller-destroy",(()=>this.destroy()),{once:!0})},destroy(){document.removeEventListener("visibilitychange",this.onVisibilityChange),i.off("shortcut.configUpdate",this.onConfigUpdate),this.actions.forEach((t=>t.destroy())),delete this.actions},getActions(){const t=t=>!!this.config.qab.enabled&&this.config.qab.actions.some((e=>e===t||t.startsWith(e)));return[{id:"yt-summary",urls:"https://www.youtube.com",label:"SUMMARIZE WITH HARPA",icon:"media-youtube",margin:"0 0 8px 0",style:".hrp-action.yt-summary {z-index: 1999}",insertTarget:"ytd-watch-next-secondary-results-renderer #items",command:"youtube-summary",sendAnalytics:"youtube-summary-click"},{id:"yt-seek",urls:"https://www.youtube.com",label:"SEEK IN VIDEO",icon:"general-search-refraction",margin:"0 0 8px 0",style:".hrp-action.yt-seek {z-index: 1999}",insertTarget:"ytd-watch-next-secondary-results-renderer #items",command:"ask",sendAnalytics:"youtube-ask-click"},{id:"post-summary-reddit",urls:"https://www.reddit.com",label:"SUMMARIZE",margin:"0 8px 0 0",insertTarget:'#main-content > shreddit-post > [slot="credit-bar"] > .flex:nth-child(2)',style:".hrp-action.post-summary-reddit {border-radius:4px}",insertPosition:"afterbegin",command:"summary",sendAnalytics:"post-summary-reddit-click",observe:!0,inputs:["SUMMARIZE 100 MESSAGES","REPORT"]},{id:"post-summary-wired",urls:"https://www.wired.com",label:"SUMMARIZE",style:".hrp-action.post-summary-wired {display: inline-block;border-radius:0px}",margin:"0 0 0 24px",insertTarget:'[data-testid="ContentHeaderRubricDateBlock"]',insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-wired-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-theverge",urls:"https://www.theverge.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-theverge {border-radius:0px}",margin:"12px 0 0 0",insertTarget:"article h1",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-theverge-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-techcrunch",urls:"https://techcrunch.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-techcrunch {border-radius:0px;height:28px;padding-top:2px}",margin:"0 0 0 24px",insertTarget:".article-hero .article-hero__date",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-techcrunch-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-medium",urls:"https://medium.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-medium {border-radius:4px;position: relative;top: -15px;}",margin:"0 0 0 40px",insertTarget:'article [data-testid="storyPublishDate"]',insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-medium-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-bbc",urls:"https://www.bbc.com/news/articles",label:"SUMMARIZE",style:'.hrp-action.post-summary-bbc {border-radius:4px;font-family:"Helvetica Neue", Helvetica, Arial, sans-serif}',margin:"0 0 0 24px",insertTarget:'article [data-testid="byline-new-contributors"]',insertPosition:"beforeend",command:"summary",sendAnalytics:"post-summary-bbc-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-cnn",urls:"https://edition.cnn.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-cnn {border-radius:4px}",margin:"0 0 0 24px",insertTarget:".headline__sub-container",insertPosition:"beforeend",command:"summary",sendAnalytics:"post-summary-cnn-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-theguardian",urls:"https://www.theguardian.com/",label:"SUMMARIZE",style:'.hrp-action.post-summary-theguardian {border-radius:4px;font-family:"Helvetica Neue", Helvetica, Arial, sans-serif}',margin:"12px 0 0 0",insertTarget:"article h1",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-theguardian-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-reuters",urls:"https://www.reuters.com/",label:"SUMMARIZE",style:'.hrp-action.post-summary-reuters {border-radius:4px;font-family:"Helvetica Neue", Helvetica, Arial, sans-serif}',margin:"12px 0 0 0",insertTarget:"article h1",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-reuters-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-apnews",urls:"https://apnews.com/article/",label:"SUMMARIZE",style:".hrp-action.post-summary-apnews {border-radius:4px}",margin:"12px 0 0 0",insertTarget:"h1.Page-headline",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-apnews-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-washingtonpost",urls:"https://www.washingtonpost.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-washingtonpost {border-radius:4px !important}.hrp-action.post-summary-washingtonpost:hover {background: #313C41 !important}",margin:"0 12px 0 8px",insertTarget:'[data-testid="article-actions-bar"]',insertPosition:"afterbegin",command:"summary",sendAnalytics:"post-summary-washingtonpost-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-aljazeera",urls:"https://www.aljazeera.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-aljazeera {border-radius:4px !important;position:relative;top:-6px}",margin:"0 12px 0 8px",insertTarget:"header.article-header .topics",insertPosition:"beforeend",command:"summary",sendAnalytics:"post-summary-aljazeera-click",observe:!0,inputs:["REPORT"]},{id:"post-summary-politico",urls:"https://www.politico.com/",label:"SUMMARIZE",style:".hrp-action.post-summary-politico {border-radius:4px !important}",margin:"12px 0 0 0",insertTarget:"section.media-item h1.headline",insertPosition:"afterend",command:"summary",sendAnalytics:"post-summary-politico-click",observe:!0,inputs:["REPORT"]},{id:"gmail-autolabel",urls:"https://mail.google.com",label:"Autolabel",icon:"finance-tag-03",margin:"-6px 16px 0 -8px",style:".hrp-action.gmail-autolabel > img {width: 16px; height: 16px}",insertTarget:'.Cq[gh="mtb"]',insertPosition:"beforebegin",command:"autolabel-gmail",sendAnalytics:"gmail-autolabel-click",observe:!0},{id:"gmail-summary",urls:"https://mail.google.com",label:"Summarize",icon:"shapes-star-06",margin:"0 0 0 16px",style:".hrp-action.gmail-summary > img {width: 18px; height: 18px}",insertTarget:"table[role=group] td:last-child",command:"summary",sendAnalytics:"gmail-summary-click",observe:!0},{id:"gmail-write",urls:"https://mail.google.com",label:"Finish Writing",icon:"maps-flag-05",margin:"0 0 0 12px",style:".hrp-action.gmail-write > img {width: 18px; height: 18px}",insertTarget:"table[role=group] td:last-child",command:"finish-writing",sendAnalytics:"gmail-write-click",observe:!0},{id:"google-search",urls:"https://www.google.com/search?",label:"AI Answer",icon:"shapes-star-07",margin:"2px 2px 2px 0",style:'#searchform[style*="position: fixed"] .hrp-action.google-search {max-height: 32px;margin:0}.hrp-action.google-search {border-radius: 20px;height: 40px;padding: 0 12px 0 10px;background: #DD5E5C !important;color: white;font-family: Google Sans, arial, sans-serif-medium, sans-serif;gap: 6px}.hrp-action.google-search > img {filter: none}',insertTarget:'button[type="submit"][aria-label]',insertPosition:"afterend",command:"search",clearChat:!0,sendAnalytics:"google-search-click",inputs:()=>["opened-serp-page"]}].map((i=>new e.Action(i.id,i,t)))}}})(),(()=>{const{$shortcut:e,$env:i,$bus:s}=t;e.hotkeyController={init(){this._pp="pp"===i.getLocus(),this._broadcastHotkeyPresses()},_broadcastHotkeyPresses(){let t;document.addEventListener("keydown",(async i=>{(i.altKey||i.ctrlKey||i.metaKey||i.shiftKey)&&(this._pp&&e.Input.isFocused()||(t||(t=await s.getTabId()),await s.send("shortcut.hotkeyPress",t,{code:i.code,altKey:i.altKey,ctrlKey:i.ctrlKey,metaKey:i.metaKey,shiftKey:i.shiftKey})))}))}}})(),(()=>{const{$shortcut:e,$bus:i,$utils:s,$startup:n}=t;e.interceptor={async setup(t){this.ACTIVATE_ON_SELECTION=!1,this.inputSelector=["[contenteditable]","input:not([type]):not(:disabled)",'input[type="text"]:not(:disabled)','input[type="email"]:not(:disabled)','input[type="search"]:not(:disabled)',"textarea:not([disabled])"].join(", "),this.bannedInputTypes=new Set(["button","checkbox","color","date","datetime","datetime-local","email","file","hidden","image","month","number","password","radio","range","reset","search","submit","tel","time","url","week"]),!this.config&&t&&(this.setupListeners(),e.launchListener(this)),t&&(this.config=t,this.setupQap())},setupListeners(){this.onFocus=this.onFocus.bind(this),document.addEventListener("focus",this.onFocus,!0),window.top===window&&(this.onSelectionChange=this.onSelectionChange.bind(this),document.addEventListener("selectionchange",this.onSelectionChange))},onSelectionChange(){this.renderQap()},onFocus(t){const e=this.input;if(this.inputPrevious!==e&&(this.inputPrevious=e,this.renderQap()),t.target.matches(this.inputSelector)){const e=document.querySelector("[data-last-active-input]");e&&e!==t.target&&e.removeAttribute("data-last-active-input"),t.target.setAttribute("data-last-active-input","")}},popupNode(){const t=document.documentElement.children[0];return t?"__HRP__"!==t.tagName?null:t.children[1]:null},setupQap(){s.isTopFrame()&&(this.destroyOldContainers(),this.container=null,this.shown=!1,this.renderQap(!0))},destroyOldContainers(){document.querySelectorAll(".HrpQab, __hrp-shortcut__").forEach((t=>{t.setAttribute("destroyed",!0),t.remove()}))},destroy(){this.container&&(this.container.remove(),this.container=null),this.config&&(document.removeEventListener("selectionchange",this.onSelectionChange),document.removeEventListener("focus",this.onFocus,!0),document.removeEventListener("blur",this.onBlur,!0)),e.launchListener&&e.launchListener.off()},computeOptions({url:t,hasSelection:e,hasInput:i}){if(e){if(!this.config?.qap.enabledSelection)return[]}else if(i){if(!this.config?.qap.enabledInput)return[]}else if(!this.config?.qap.enabledMain)return[];let s=this.config.mapping;s=e?s.filter((t=>t.hasSelection)):i?s.filter((t=>t.hasInput)):s.filter((t=>!t.hasSelection&&!t.hasInput));const n=s.filter((t=>t.urls)).filter((e=>e.urls.some((e=>e.startsWith("RegExp=")?new RegExp(e.slice(7),"i").test(t):t.includes(e))))).map((t=>t.options)).flat();return n.length>0?n:s.filter((t=>!t.urls)).map((t=>t.options)).flat()},get selection(){return document.getSelection().toString().trim()},get hasSelection(){return this.selection.length>0},get input(){const t=this.activeInput();return t?t?.value||t?.innerText||t?.textContent||"":null},get hasInput(){return!!this.activeInput()},isBlacklisted(){if(this.blacklisted)return!0;if("https://harpa.ai/login"===location.href)return!0;const t=this.config?.qap.blacklist.trim();if(!t)return!1;const e=location.href.split("/")[2],s=t.split(/[\s,]+/).find((t=>e.includes(t.replace(/^https?:\/\//,"").split(":")[0])));return!!s&&(s.endsWith(":once")&&i.send("shortcut.whitelistQap",s),this.blacklisted=!0,!0)},activeInput(){const t=document.activeElement;if(!t?.matches(this.inputSelector))return!1;const e=t.attributes.type?.value;return!this.bannedInputTypes.has(e)&&(!Array.from(t.attributes).some((t=>t.value.includes("search")))&&t)},renderQap(t){if(!s.isTopFrame())return;if("text/html"!==document.contentType)return;const e=this.config?.qap;if(!e.enabledMain&&!e.enabledInput&&!e.enabledSelection)return this.hideContainer();if(this.container?.getAttribute("destroyed"))return this.destroy();if(this.isBlacklisted())return this.hideContainer();const i=this.hasSelection,n=this.hasInput,r={url:window.location.href,hasSelection:i,hasInput:n};if(!t&&this.opts&&this.opts.url===r.url&&this.opts.hasSelection===r.hasSelection&&this.opts.hasInput===r.hasInput)return;this.opts=r;const o=this.computeOptions(this.opts);if(0===o.length)return this.hideContainer();this.createContainer(),this.createOptions(o),this.ACTIVATE_ON_SELECTION&&this.container.classList.toggle("HrpQab_active",i&&!n),this.showContainer()},isActivated(){return this.container?.classList.contains("HrpQab_active")},activateQap(){this.container&&(this.container.classList.toggle("HrpQab_active",!0),this.showContainer())},deactivateQap(){this.container&&this.container.classList.toggle("HrpQab_active",!1)},async launchOption(t){if(!this.container)return;if(!this.options?.length)return null;if("main"===t){const t=await i.getTabId();return await i.send("browser.toggleFrame",t),!0}const e=this.options.indexOf(t),s=Array.from(document.querySelectorAll(".HrpQab__button_option")),n=s[s.length-e-1]?.onMouseDown;return!!n&&(n(),!0)},hideContainer(){if(!this.shown)return;this.shown=!1;const t=this.container;t&&(t.style.opacity=0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout((()=>{document.documentElement===t.parentNode&&document.documentElement.removeChild(t)}),50))},createOptions(t){if(!this.container)return;this.container.querySelectorAll(".HrpQab__button_option").forEach((t=>t.remove()));const e=(e,i)=>{if(!this.config?.qap?.enabledHotkeys)return null;if(e.hotkey)return e.hotkey;let s=t.length-i;return s>10?s=null:10===s&&(s=0),s};this.options=t,t.reverse().forEach(((t,i)=>{this.prependButton(t,e(t,i))})),this.close=this.prependButton("close")},optionForHotkey(t){if(!this.container)return null;if(!this.options?.length)return null;if("/"===t)return"main";let e=Number(t);return 0===e?this.options[this.options.length-10]:Number.isNaN(e)?this.options.find((e=>e.hotkey===t)):this.options[this.options.length-e]},showContainer(){this.shown=!0,this.container.style.opacity=1},prependButton(t,e){const s=document.createElement("div");s.style.order=1,s.classList.add("HrpQab__button"),"main"!==t?s.classList.add("HrpQab__button_option"):s.classList.add("HrpQab__button_main");const n=document.createElement("img");try{n.src=chrome.runtime.getURL(`/img/commands/${t.icon||t}.svg`)}catch{return}s.appendChild(n);const r='<span class="HrpQab__hotkeyPrefix">//</span>',o=document.createElement("div");if(o.classList.add("HrpQab__tooltip"),"main"===t)o.classList.add("HrpQab__tooltip_main"),o.innerHTML=(this.config?.qap?.enabledHotkeys?`<div class="HrpQab__hotkey">${r}/</div>`:"")+'<div class="HrpQab__message">AI CHAT</br>Drag to move';else if("close"===t)o.classList.add("HrpQab__tooltip_close"),o.innerHTML='<div class="HrpQab__message">'+(this.hasSelection?"CLOSE & DISABLE SELECTION BAR<br/>":"CLOSE & DISABLE AI BAR<br/>")+"• ALT → Disable for website<br/>• SHIFT → Close once</div>";else if(null!==e){const i=t.label||"USER COMMAND";o.classList.add("HrpQab__tooltip_command");const s=String(e).toUpperCase();o.innerHTML=`<div class="HrpQab__hotkey"><b>${r}${s}</b></div><div class="HrpQab__message">${i}</div>`}else{const e=t.label||"USER COMMAND";o.classList.add("HrpQab__tooltip_command"),o.innerHTML=`<div class="HrpQab__message">${e}</div>`}s.appendChild(o);const a=document.createElement("div");if(a.classList.add("HrpQab__triangle"),o.appendChild(a),"main"===t)s.addEventListener("click",(async t=>{if(this.isDragging)return;t.stopImmediatePropagation();const e=await i.getTabId();await i.send("browser.toggleFrame",e)}));else if("close"===t)s.addEventListener("click",(async t=>{if(this.isDragging)return;t.stopImmediatePropagation();const e=location.href.split("/")[2];if(t.shiftKey)await i.send("shortcut.blacklistQap",`${e}:once`);else if(t.altKey)await i.send("shortcut.blacklistQap",e);else{const t=this.hasSelection?"selection":this.hasInput?"input":"main";await i.send("shortcut.blacklistQap",t)}}));else{let e=null;const n=()=>({...t,inputs:(t.inputs||[]).map((t=>"{{selection}}"===t?this.selection:"{{input}}"===t?e||(e=this.input,e=/\/\/.$/.test(e)?e.slice(0,-3):e,e):t))}),r=t=>{this.isDragging||(t.preventDefault(),t.stopImmediatePropagation())},o=async()=>{if(this.isDragging)return;const e=await i.getTabId(),s=document.documentElement;t.hideFrame&&s.classList.add("HrpFrame--hidden"),await i.send("browser.toggleFrame",e),await i.send("shortcut.executeCommand",e,n()),t.hideFrame&&setTimeout((()=>s.classList.remove("HrpFrame--hidden")),1e3)};s.addEventListener("mousedown",o),s.addEventListener("mousedown",r),s.addEventListener("mouseup",r),s.addEventListener("click",r),s.onMouseDown=o}return this.container.prepend(s),s},positionContainer(){const{snap:t,delta:e}=this.config.qap;t.startsWith("right:")?(this.container.style.right="0px",this.container.style.left="auto"):t.startsWith("left:")&&(this.container.style.left="0px",this.container.style.right="auto"),t.endsWith(":bottom")?(this.container.style.bottom=`${e}px`,this.container.style.top="auto",this.container.classList.toggle("HrpQab_normal",!0),this.container.classList.toggle("HrpQab_reversed",!1),this.main.style.order=2):t.endsWith(":top")&&(this.container.style.top=`${e}px`,this.container.style.bottom="auto",this.container.classList.toggle("HrpQab_normal",!1),this.container.classList.toggle("HrpQab_reversed",!0),this.main.style.order=0)},createContainer(){if(!this.container){{const t=n.controller.ensureRootElement();this.container=document.createElement("div"),this.container.classList.add("HrpQab"),this.container.addEventListener("mousedown",(()=>{document.addEventListener("blur",(t=>{t.preventDefault(),t.stopPropagation()}),{once:!0,capture:!0})})),t.append(this.container)}{this.main=this.prependButton("main"),this.positionContainer(),this.isDragging=!1;let t=this.config.qap.delta,e=this.config.qap.snap;this.main.addEventListener("mousedown",(s=>{s.preventDefault();const n=i=>{if(e.endsWith(":top")?t+=i.movementY:e.endsWith(":bottom")&&(t-=i.movementY),t<8&&(t=8),!this.isDragging){if(Math.abs(this.config.qap.delta-t)<12)return;this.isDragging=!0,this.container.classList.add("HrpQab_active")}this.config.qap.delta=t,this.positionContainer()},r=()=>{if(this.hasSelection||this.container.classList.remove("HrpQab_active"),this.isDragging){const s=window.innerHeight;t=Math.max(8,t),t>s/2&&(t=Math.max(8,s-t-this.container.offsetHeight),e.endsWith(":top")?e=e.replace(":top",":bottom"):e.endsWith(":bottom")&&(e=e.replace(":bottom",":top"))),this.config.qap.delta=t,this.config.qap.snap=e,this.positionContainer(),i.send("shortcut.updateQap",{delta:t,snap:e}),setTimeout((()=>this.isDragging=!1),50)}document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)}))}}}}})(),(()=>{const{$statistics:e,$bus:i}=t;e.controller={init(){const t=()=>i.send("statistics.ua");document.addEventListener("click",t,!0),document.addEventListener("submit",t,!0)}},e.controller.init()})(),(()=>{const{$bus:e,$env:i,$utils:s}=t;e.controller={async init(){e.on=this.on.bind(this),e.off=this.off.bind(this),e.once=this.once.bind(this),e.send=this._wrapThrowIfError(this.send),e.call=this._wrapThrowIfError(this.call),e.poll=this.poll.bind(this),e.getTabId=this.getTabId.bind(this),this._locus=i.getLocus(),this._serialize=this._serialize.bind(this),this._handlers={},this._is("pp")?(this._setupPp(),this._tabId=await e.getTabId()):this._is("bg")?(this._blobs={},this._channel=new BroadcastChannel("bus.channel"),this._setupBg()):this._is("cs")?await this._setupCs():this._is("nj")?this._setupNj():this._is("os")?(e.setIframe=t=>this._iframe=t,this._iframe=null,this._channel=new BroadcastChannel("bus.channel"),this._setupOs()):this._is("oi")&&this._setupOi()},on(t,e,i=null){this._on(t,null,e,i)},off(t,e=null){this._off(t,null,e)},once(t,e){const i=async(...s)=>(this.off(t,i),await e(...s));this.on(t,i)},async send(t,...i){if(s.is.numeric(t)){const e=Number(t);return t=i[0],i=i.slice(1),await this._pick([this._sendToCs(e,t,...i),this._sendToExt(e,t,...i)])}if(this._is("pp"))return await this._sendToExt(t,...i);if(this._is("nj"))return await this._sendToPage(t,...i);if(this._is("oi"))return await this._sendToParent(t,...i);if(this._is("bg","cs","os"))return await this._pick([this._sendToExt(t,...i),this._callHandlers({name:t,args:i},(t=>t.proxy))]);if(this._is("fg")){if("store.actions"===t)return;if("idb.change"===t)return;e.log(t,...i)}},async call(t,...e){return this._callHandlers({name:t,args:e},(t=>!t.proxy))},async poll(t,...e){return await s.waitFor((()=>this.send(t,...e)))},async getTabId(){if(this._is("bg"))return null;if(this._is("pp")){const t=new URL(location.href).searchParams.get("tabId");if(t)return Number(t)}const{tabId:t}=await this.send("bus.getTabData");return t},_on(t,e,i,s=null){this._handlers[t]||(this._handlers[t]=[]),this._is("cs","nj","oi")&&0===this._handlers[t].length&&this._sendToProxier("bus.proxy",t,!0);const n={fn:i,name:t};e&&(n.proxy=e),s&&(n.this=s),this._handlers[t].push(n)},_off(t,e=null,i=null){this._handlers[t]&&(this._handlers[t]=this._handlers[t].filter((t=>{const s=!i||i===t.fn,n=e===(t.proxy||null);return!s||!n})),0===this._handlers[t].length&&(delete this._handlers[t],this._is("cs","nj","oi")&&this._sendToProxier("bus.proxy",t,!1)))},_setupPp(){},_setupBg(){},async _setupCs(){chrome.runtime.onMessage.addListener(((t,e,i)=>{if(!this._isBusMsg(t))return;const s=this._callHandlers(t);return s?(s.then(this._serialize).then(i),!0):void 0})),window.addEventListener("message",(async({data:e})=>{if(!this._isBusMsg(e))return;if("nj"!==e.locus)return;if("bus.proxy"===e.name){const[i,s]=e.args;return s?this._on(i,"nj",((...t)=>this._sendToPage(i,...t))):this._off(i,"nj"),void t(e)}const i=await this._pick([this._sendToExt(e.name,...e.args),this._callHandlers(e,(t=>!t.proxy))]);t(e,i)}));const t=(t,e=null)=>{window.postMessage({resId:t.reqId,result:e},"*")};await this._sendToProxier("bus.removeCsProxies")},_setupNj(){},_setupOs(){},_setupOi(){},async _sendToExt(t,...i){let n=null;s.is.numeric(t)&&(n=Number(t),t=i[0],i=i.slice(1));const r=this._serialize(i),o=this._createBusMsg({name:t,argsStr:r,target:n}),a=await new Promise((t=>{try{chrome.runtime.sendMessage(o,(e=>{chrome.runtime.lastError?t(null):t(e)}))}catch(i){if("Extension context invalidated."===i.message)return;e.error(i),t(null)}}));return await this._deserialize(a)},async _sendToCs(t,e,...i){if(!chrome.tabs?.sendMessage)return await this.send("bus.sendToCs",t,e,...i);const s=this._serialize(i),n=this._createBusMsg({name:e,argsStr:s,target:"cs"}),r=await new Promise((e=>{chrome.tabs.sendMessage(t,n,(t=>{chrome.runtime.lastError?e(null):e(t)}))}));return await this._deserialize(r)},async _sendToPage(t,...e){const i=this._generateId(),s=this._createBusMsg({name:t,args:e,reqId:i,locus:this._locus});return window.postMessage(s,"*"),await this._waitForResponseMessage(i)},async _sendToIframe(t,...e){if(!this._iframe)return null;const i=this._generateId(),s=this._createBusMsg({name:t,args:e,reqId:i});return this._iframe.contentWindow.postMessage(s,"*"),await this._waitForResponseMessage(i)},async _sendToParent(t,...e){const i=this._generateId(),s=this._createBusMsg({name:t,args:e,reqId:i});return parent.postMessage(s,"*"),await this._waitForResponseMessage(i)},async _sendToProxier(t,...e){return this._is("cs")?await this._sendToExt(t,...e):this._is("nj")?await this._sendToPage(t,...e):this._is("oi")?await this._sendToParent(t,...e):void 0},_waitForResponseMessage:async t=>await new Promise((e=>{const i=({data:s})=>{!(!s||s.resId!==t)&&(window.removeEventListener("message",i),e(s.result))};window.addEventListener("message",i)})),_callHandlers({name:t,args:i,argsStr:s},n=null){let r=this._handlers[t];return r?(n&&(r=r.filter(n)),0===r.length?null:new Promise((async t=>{s&&(i=await this._deserialize(s));t(await this._pick(r.map((async t=>{try{return await t.fn.call(t.this,...i)}catch(i){return e.error(`failed to handle "${t.name}".`,i),i}}))))}))):null},_removeProxyHandlers(t){Object.keys(this._handlers).forEach((e=>{this._handlers[e]=this._handlers[e].filter((e=>e.proxy!==t)),0===this._handlers[e].length&&delete this._handlers[e]}))},_serialize(t){return s.is.nil(t)?null:JSON.stringify(t,((t,e)=>{if(s.is.blob(e)){if(this._is("bg")){const t=this._generateId();return this._blobs[t]=e,`bus.blob.${t}`}return`bus.blob.${s.objectUrl.create(e,!0)}`}return s.is.error(e)?`bus.error.${e.message}`:e}))},async _deserialize(t){if(!s.is.string(t))return null;const e=new Map,i=JSON.parse(t,((t,i)=>{const n=s.is.string(i);return n&&i.startsWith("bus.blob.")?(e.set(i,i.slice("bus.blob.".length)),i):n&&i.startsWith("bus.error.")?new Error(i.slice("bus.error.".length)):i}));return await Promise.all([...e.keys()].map((async t=>{let i;const s=e.get(t);i=s.startsWith("blob:")?s:await this._sendToExt("bus.blobIdToObjectUrl",s);const n=await fetch(i).then((t=>t.blob()));e.set(t,n)}))),this._applyBlobs(i,e)},_applyBlobs(t,e){if(e.has(t))return e.get(t);if(s.is.array(t)||s.is.object(t))for(const i in t)t[i]=this._applyBlobs(t[i],e);return t},async _blobIdToObjectUrl(t){},async _blobToObjectUrl(t){},_is(...t){return t.includes(this._locus)},_isBusMsg:e=>e&&e.$bus&&e.appName===t.name,_createBusMsg:e=>({$bus:!0,appName:t.name,...e}),_generateId:()=>`bus-${Date.now()}-${Math.random().toString(36).slice(2)}`,_wrapThrowIfError(t){return async(...e)=>{const i=await t.call(this,...e);if(s.is.error(i))throw i;return i}},_pick:async(t=[])=>0===t.length?null:await new Promise((e=>{let i=0;t.forEach((async n=>{const r=await n;return s.is.nil(r)?i===t.length-1?e(null):void i++:e(r)}))}))}})(),(()=>{const{$env:e}=t;e.getLocus=()=>{const{protocol:t,host:e,pathname:i,href:s}=location;return"https://harpa.ai/oi"===s||"http://localhost:3000/oi"===s||"http://localhost:3010/oi"===s?"oi":"chrome-extension:"!==t&&chrome?.runtime?.getURL?"cs":"localhost:3050"===e?"fg":"chrome-extension:"!==t?"nj":"/harpa.html"===i?"pp":"/offscreen.html"===i?"os":"bg"}})(),(()=>{const{$utils:e}=t;e.callAsync=async(t,...e)=>new Promise((i=>t(...e,i)))})(),(()=>{const{$utils:e}=t;e.createPromise=()=>{let t=null,e=null;const i=new Promise(((i,s)=>{t=i,e=s}));return Object.defineProperty(i,"resolve",{get:()=>t}),Object.defineProperty(i,"reject",{get:()=>e}),i}})(),(()=>{const{$utils:e}=t;e.isTopFrame=()=>globalThis.top===globalThis})(),(()=>{const{$utils:e}=t;e.is={null:t=>null===t,defined:t=>void 0!==t,undefined:t=>void 0===t,nil:t=>null==t,boolean:t=>"boolean"==typeof t,number:t=>"number"==typeof t,string:t=>"string"==typeof t,symbol:t=>"symbol"==typeof t,function:t=>"function"==typeof t,map:t=>t instanceof Map,set:t=>t instanceof Set,url:t=>t instanceof URL,blob:t=>t instanceof Blob,file:t=>t instanceof File,error:t=>t instanceof Error,regexp:t=>t instanceof RegExp,array:t=>Array.isArray(t),object:t=>"[object Object]"===Object.prototype.toString.call(t),nan:t=>Number.isNaN(t),nonPrimitive:t=>e.is.object(t)||e.is.array(t),numeric:t=>!e.is.nan(Number(t)),empty:t=>!!e.is.nil(t)||(e.is.array(t)?0===t.length:e.is.object(t)?0===Object.keys(t).length:!!e.is.string(t)&&0===t.trim().length)}})(),(()=>{const{$utils:e,$bus:i}=t;e.objectUrl={create(t,s=!1){if(!URL.createObjectURL)return i.send("utils.objectUrl.create",t,s);const n=URL.createObjectURL(t);if(s){const t=e.is.number(s)?s:6e4;setTimeout((()=>URL.revokeObjectURL(n)),t)}return n},revoke(t){if(!URL.revokeObjectURL)return i.send("utils.objectUrl.revoke",t);URL.revokeObjectURL(t)}}})(),Array.prototype.toReversed&&(Array.prototype.toReversed=function(){return[...this].reverse()}),Array.prototype.at||(Array.prototype.at=function(t){return this[t>=0?t:this.length+t]}),Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(t,e){for(let i=this.length-1;i>=0;i--)if(t.call(e,this[i],i,this))return i;return-1}),(()=>{const{$utils:e}=t;e.sleep=async t=>new Promise((e=>{setTimeout(e,t)}))})(),(()=>{const{$utils:e}=t;e.waitFor=async(t,{interval:i=100,timeout:s=6e4}={})=>{if(s<=0)throw new Error("$utils.waitFor: timeout exceeded");const n=Date.now(),r=await t();if(r)return r;await e.sleep(i);const o=Date.now()-n;return e.waitFor(t,{interval:i,timeout:s-o})}})(),(()=>{const{$startup:e,$shortcut:i,$engine:s,$utils:n,$bus:r}=t;e.controller={async init(){this._root=null,this._loaders={},this._saveGlobals(),this._patchTrustedTypes(),this._patchServiceWorker(),await r.controller.init(),await s.controller.init(),await this.insert("/nj.css"),await i.controller.init(),n.isTopFrame()&&(this._manageGlobalClasses(),this._insertYoutubeScript(),this._insertChatGptScript(),r.on("startup.insert",this.insert,this));const t=await r.getTabId();await r.send("startup.csStarted",t)},async insert(t){if(this._loaders[t])return this._loaders[t];this._loaders[t]=n.createPromise(),t.endsWith(".js")?await this._insertScript(t):t.endsWith(".css")&&await this._insertStyle(t),this._loaders[t].resolve()},async _insertScript(t){"/nj.js"!==t&&await this.insert("/nj.js");const i=this.ensureRootElement(),s=document.createElement("script");s.src=chrome.runtime.getURL(t);try{await new Promise(((t,e)=>{s.onload=t,s.onerror=e,i.append(s)}))}catch{e.error("failed to load script",t)}finally{s.remove()}},async _insertStyle(t){const i=this.ensureRootElement(),s=document.createElement("link");s.href=chrome.runtime.getURL(t),s.rel="stylesheet";try{await new Promise(((t,e)=>{s.onload=t,s.onerror=e,i.append(s)}))}catch{e.error("failed to load style",t)}},executeJs(t,...e){n.is.function(t)&&(t=`(${t.toString()}).call(null, ...${JSON.stringify(e)})`);const i=document.createElement("div");i.setAttribute("onreset",`const URL = window.URL; ${t}`),i.dispatchEvent(new Event("reset"))},ensureRootElement(){if(this._root)return this._root;const t=document.querySelector("__hrp__");let e;t&&t.remove(),this._root=document.createElement("__hrp__"),this._root.setAttribute("data-ext-id",chrome.runtime.id),this._root.style.setProperty("position","relative","important"),this._root.style.setProperty("z-index","2147483647","important"),document.documentElement.prepend(this._root);const i=()=>{e&&e.disconnect(),e=new MutationObserver((t=>{for(const e of t)for(const t of e.removedNodes)if(t===this._root){document.documentElement.prepend(this._root);break}})),e.observe(document.documentElement,{childList:!0})};return i(),new MutationObserver((t=>{for(const e of t)for(const t of e.addedNodes)if(t instanceof HTMLHtmlElement){document.documentElement.prepend(this._root),i();break}})).observe(document,{childList:!0}),this._root},_saveGlobals(){this.executeJs((()=>{window.__hrp_globals={fetch:window.fetch,postMessage:window.postMessage,localStorage:window.localStorage,XMLHttpRequest:window.XMLHttpRequest,setTimeout:window.setTimeout,setInterval:window.setInterval,clearTimeout:window.clearTimeout,clearInterval:window.clearInterval,addEventListener:window.addEventListener,removeEventListener:window.removeEventListener};const t=Object.defineProperty.bind(Object);Object.defineProperty=(...e)=>{if(e[0]!==globalThis||!(e[1]in window.__hrp_globals))return t(...e)};const e=String.prototype.replaceAll;Object.defineProperty(String.prototype,"replaceAll",{get:()=>e,set:()=>{}})}))},_patchTrustedTypes(){this.executeJs((()=>{const t=trustedTypes.createPolicy.bind(trustedTypes);trustedTypes.createPolicy=(e,i)=>t(e,"default"!==e?i:{createHTML:t=>t,createScript:t=>t,createScriptURL:t=>t})}))},_patchServiceWorker(){this.executeJs((()=>{const t=navigator.serviceWorker.register;navigator.serviceWorker.register=async function(...e){try{if((await fetch(e[0]).then((t=>t.text()))).toLowerCase().includes("content-security-policy"))return}catch(t){console.error(t)}return t.call(this,...e)}}))},_manageGlobalClasses(){const t=["https://app.harpa.ai/","https://harpa.ai/app","http://localhost:3010/app","http://localhost:3000/app"].some((t=>location.href.startsWith(t))),e=["https://welcome.harpa.ai/","https://harpa.ai/welcome","http://localhost:3010/welcome","http://localhost:3000/welcome"].includes(location.href);document.documentElement.classList.toggle("Hrp--app",t),document.documentElement.classList.toggle("Hrp--welcome",e)},_insertYoutubeScript(){location.host?.endsWith("youtube.com")&&this.insert("/nj-youtube.js")},_insertChatGptScript(){if(!location.host?.endsWith("chatgpt.com"))return;let t=!1,e=document.documentElement.classList.contains("dark");const i=()=>{t||(t=!0,s.disconnect(),this.insert("/nj-chatgpt.js"))},s=new MutationObserver((()=>{const t=document.documentElement.classList.contains("dark");t!==e&&(e=t,setTimeout(i,300))}));s.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),setTimeout(i,1e3)}},e.controller.init()})()})();