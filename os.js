(()=>{let e;var t;(()=>{const t="__app_hrp",r="production",s=!1;if(e=globalThis[t],e)return;const n={name:t,env:r,get:e=>e in n?n[e]:null,...JSON.parse('{"version":"11.4.0"}')},i=function e(t){const r=t===n,i=r&&s,l={},c=e=>Object.assign(t,e),h=new Proxy(t,{get(s,n){if("assign"===n)return c;if(r&&!String(n).startsWith("$"))return t[n];if(!(n in t)){if(t[n]={},r){const e=o.bind(null,"log",n,!1),r=o.bind(null,"log",n,!0),s=o.bind(null,"warn",n,!1),i=o.bind(null,"warn",n,!0),l=o.bind(null,"error",n,!1),c=o.bind(null,"error",n,!0),h=a.bind(null,n);Object.defineProperties(t[n],{log:{get:()=>e},logDev:{get:()=>r},warn:{get:()=>s},warnDev:{get:()=>i},error:{get:()=>l},errorDev:{get:()=>c},Error:{get:()=>h}})}l[n]=e(t[n]),i&&(globalThis[n]=t[n])}return n in l?l[n]:t[n]},set:(e,r,s)=>(t[r]=s,l[r]=s,i&&(globalThis[r]=t[r]),!0)});return h}(n);function o(e,t,r,...s){if(r)return;const[n,i,o]=function(e){let t=0;e.split("").forEach(((r,s)=>{t=e.charCodeAt(s)+((t<<5)-t)}));return[(16711680&t)>>16,(65280&t)>>8,255&t]}(t);console[e](`%c[${t}]`,`color: rgb(${n}, ${i}, ${o})`,...s)}function a(e,t,...r){return r.length>0&&o("error",e,!1,t,...r),new Error(`[${e}] ${t}`)}globalThis[t]=i,e=i})(),t=e=>crypto.getRandomValues(new Uint8Array(e)),e.$nanoid=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e));for(;e--;){let s=63&r[e];t+=s<36?s.toString(36):s<62?(s-26).toString(36).toUpperCase():s<63?"_":"-"}return t},e.$nanoid.customAlphabet=(e,r)=>((e,t,r)=>{let s=(2<<Math.log(e.length-1)/Math.LN2)-1,n=-~(1.6*s*t/e.length);return()=>{let i="";for(;;){let o=r(n),a=n;for(;a--;)if(i+=e[o[a]&s]||"",i.length===t)return i}}})(e,r,t),(()=>{const{$utils:t}=e;t.canvasToBlob=async(e,t="image/webp",r=.9)=>await new Promise(((s,n)=>{try{e.toBlob((t=>{t?s(t):0===e.width||0===e.height?n("canvas.toBlob failed, canvas has no dimensions"):n("canvas.toBlob failed")}),t,r)}catch(e){n(e)}}))})(),(()=>{const{$utils:t}=e;t.clearFromTags=e=>e?(t.is.string(e)||(e=String(e)),e.replaceAll(/<\w+>/g,"").replaceAll(/<\/\w+>/g,"").replaceAll(/<\w+\/>/g,"")):e})(),(()=>{const{$utils:t}=e;t.createPromise=()=>{let e=null,t=null;const r=new Promise(((r,s)=>{e=r,t=s}));return Object.defineProperty(r,"resolve",{get:()=>e}),Object.defineProperty(r,"reject",{get:()=>t}),r}})(),(()=>{const{$utils:t,$nanoid:r}=e;t.id={pico(e=[]){const t="0123456789abcdefghijklmnopqrstuvwxyz";if(e.length>=t.length**4)throw new Error("Cannot generate more IDs");let r;do{r="";for(let e=0;e<4;e++){const e=Math.floor(Math.random()*t.length);r+=t.charAt(e)}}while(e.includes(r));return r},nano(e=[]){let t;do{t=r()}while(e.includes(t));return t},uuid(e=[]){let t;do{t=crypto.randomUUID()}while(e.includes(t));return t}}})(),(()=>{const{$utils:t}=e;t.is={null:e=>null===e,defined:e=>void 0!==e,undefined:e=>void 0===e,nil:e=>null==e,boolean:e=>"boolean"==typeof e,number:e=>"number"==typeof e,string:e=>"string"==typeof e,symbol:e=>"symbol"==typeof e,function:e=>"function"==typeof e,map:e=>e instanceof Map,set:e=>e instanceof Set,url:e=>e instanceof URL,blob:e=>e instanceof Blob,file:e=>e instanceof File,error:e=>e instanceof Error,regexp:e=>e instanceof RegExp,array:e=>Array.isArray(e),object:e=>"[object Object]"===Object.prototype.toString.call(e),nan:e=>Number.isNaN(e),nonPrimitive:e=>t.is.object(e)||t.is.array(e),numeric:e=>!t.is.nan(Number(e)),empty:e=>!!t.is.nil(e)||(t.is.array(e)?0===e.length:t.is.object(e)?0===Object.keys(e).length:!!t.is.string(e)&&0===e.trim().length)}})(),(()=>{const{$utils:t,$bus:r}=e;t.ls={get(e,t){if(!this._supported())return r.send("utils.ls.get",e,t);if(!this.has(e))return t;const s=localStorage.getItem(e);if("undefined"===s)return;if("null"===s)return null;if("true"===s)return!0;if("false"===s)return!1;if(s.startsWith("[")||s.startsWith("{"))return JSON.parse(s);const n=Number(s);return Number.isNaN(n)?s:n},set(e,t){if(!this._supported())return r.send("utils.ls.set",e,t);try{"string"==typeof t?localStorage.setItem(e,t):localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("$utils.ls.set failed to store the given value",{key:e,value:t,error:r})}},has(e){return this._supported()?e in localStorage:r.send("utils.ls.has",e)},remove(e){if(!this._supported())return r.send("utils.ls.remove",e);localStorage.removeItem(e)},_supported:()=>!!globalThis.localStorage}})(),(()=>{const{$utils:t,$bus:r}=e;t.objectUrl={create(e,s=!1){if(!URL.createObjectURL)return r.send("utils.objectUrl.create",e,s);const n=URL.createObjectURL(e);if(s){const e=t.is.number(s)?s:6e4;setTimeout((()=>URL.revokeObjectURL(n)),e)}return n},revoke(e){if(!URL.revokeObjectURL)return r.send("utils.objectUrl.revoke",e);URL.revokeObjectURL(e)}}})(),Array.prototype.toReversed&&(Array.prototype.toReversed=function(){return[...this].reverse()}),Array.prototype.at||(Array.prototype.at=function(e){return this[e>=0?e:this.length+e]}),Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(e,t){for(let r=this.length-1;r>=0;r--)if(e.call(t,this[r],r,this))return r;return-1}),(()=>{const{$utils:t}=e;t.sleep=async e=>new Promise((t=>{setTimeout(t,e)}))})(),(()=>{const{$utils:t}=e,r=36e5,s=24*r,n=365*s,i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=e=>{if(!e)return null;if("string"==typeof e)return"string";const t=new Date;if(e>t.getTime()){if(t.setHours(0,0,0,0),e<=t.getTime()+s)return"today";if(e<=t.getTime()+2*s)return"tomorrow";if(t.setHours(23,59,59,999),t.setMonth(11,31),e<=t)return"year"}else{if(t.setHours(0,0,0,0),e>=t.getTime())return"today";if(e>=t.getTime()-s)return"yesterday";if(t.setMonth(0,1),e>=t.getTime())return"year"}return"other"};t.time={SECOND:1e3,MINUTE:6e4,HOUR:r,DAY:s,WEEK:6048e5,MONTH:26784e5,YEAR:n,MILLENNIUM:31536e9,months:i,fullMonths:["January","February","March","April","May","June","July","August","September","October","November","December"],relativeDateType:o,formatTime:(e,t)=>(t=t||{hour12:!1,timeZone:"UTC"},(e=(e=e||new Date)instanceof Date?e:new Date(e)).toLocaleTimeString("en-UK",t)),formatDate:(e,t)=>e?(e=e instanceof Date?e:new Date(e),t={day:"numeric",month:"short",year:"numeric",hour12:!1,...t},0===e.getUTCHours()&&0===e.getUTCMinutes()&&0===e.getUTCSeconds()?e.toLocaleDateString("en-UK",t):e.toLocaleTimeString("en-UK",t)):null,formatRelativeDate:(e,t=!1)=>{if(!e)return null;const r=o(e);if("string"===r)return e;function s(e){return e<10?`0${e}`:e}const n=new Date(e),a=(!t||0!==n.getHours()||0!==n.getMinutes())&&`${s(n.getHours())}:${s(n.getMinutes())}`;if("tomorrow"===r)return a?`Tomorrow ${a}`:"Tomorrow";if("today"===r)return a?`${a}, Today`:"Today";if("yesterday"===r)return a?`Yesterday ${a}`:"Yesterday";const l=n.getDate(),c=i[n.getMonth()];if("year"===r)return a?`${l} ${c} ${a}`:`${l} ${c}`;const h=n.getFullYear();return"other"===r?a?`${l} ${c} ${h}, ${a}`:`${l} ${c} ${h}`:e},formatDuration:e=>{if(0===e)return"0s";const t=Math.abs(e/1e3);let r=1e3*t%1e3;r=r&&`${r}ms`;let s=Math.floor(t%60);s=s&&`${s}s`;let n=Math.floor(t/60)%60;n=n&&`${n}m`;let i=Math.floor(t/3600)%24;i=i&&`${i}h`;let o=Math.floor(t/86400);return o=o&&`${o}d`,[o,i,n,s,r].filter((e=>Boolean(e))).join(" ")},frequencyToMs:e=>{const r={s:t.time.SECOND,m:t.time.MINUTE,h:t.time.HOUR,d:t.time.DAY,w:t.time.WEEK,mo:t.time.MONTH},s=parseInt(e.match(/\d+/));if(!s)return 0;const n=r[e.match(/\D+/)]||0;return n&&s*n||0},startOfDayGmt0:()=>new Date((new Date).setUTCHours(0,0,0,0)),since:e=>Date.now()-Number(e)}})(),(()=>{const{$utils:t}=e;t.versionNumber=e=>{e=e||"0.0.0";const[t,r,s]=e.split(".");return 1e6*(Number(t)||0)+1e3*(Number(r)||0)+(Number(s)||0)}})(),(()=>{const{$utils:t}=e;t.waitFor=async(e,{interval:r=100,timeout:s=6e4}={})=>{if(s<=0)throw new Error("$utils.waitFor: timeout exceeded");const n=Date.now(),i=await e();if(i)return i;await t.sleep(r);const o=Date.now()-n;return t.waitFor(e,{interval:r,timeout:s-o})}})(),(()=>{const{$ai:t,$bus:r}=e;t.controller={init(){r.on("ai.countTextTokens",this._countTextTokens,this)},_countTextTokens:async(e,r)=>await t.tokenizer.countTextTokens(e,r)}})(),(()=>{const{$ai:t,$utils:r}=e;t.tokenizer={async countTextTokens(e,t){const s=this._ensureWorker(),n=r.id.nano();return await new Promise(((r,i)=>{const o=e=>{e.data&&e.data.resId===n&&(s.removeEventListener("message",o),r(e.data.tokens))};s.addEventListener("message",o),s.addEventListener("error",(e=>i(e))),s.postMessage({text:e,encoding:t,reqId:n})}))},_ensureWorker(){return this._worker||(this._worker=new Worker("/gpt-tokenizer.js")),clearTimeout(this._terminateWorkerTimer),this._terminateWorkerTimer=setTimeout((()=>{this._worker&&(this._worker.terminate(),this._worker=null)}),10*r.time.MINUTE),this._worker}}})(),(()=>{const{$chat:t}=e;t.paramSerp.toText=e=>{if("—"===e)return"—";const r=e.match(/<body[^>]*>([\s\S]*?)<\/body>/i);if(!r||!r[1])return"—";let s=r[1];s=s.replaceAll(/src="[^"]*"/g,"").replaceAll(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replaceAll(/<script[^>]*>[\s\S]*?<\/script>/gi,"");let n=document.createElement("div");n.innerHTML=s,Array.from(n.querySelectorAll('script, style, img, svg, g-snackbar, g-inline-toggler, h2, cite, *[style="display:none"]')).forEach((e=>e.remove())),Array.from(n.querySelectorAll("g-section-with-header")).filter((e=>e.innerText.startsWith("Images for "))).forEach((e=>e.remove())),Array.from(n.querySelectorAll(".related-question-pair")).forEach((e=>e.remove())),Array.from(n.querySelectorAll("[role=button]")).filter((e=>!("SPAN"===e.tagName&&"wob_t"===e.getAttribute("class")&&"display:inline"===e.getAttribute("style")||e.getAttribute("data-q")||e.querySelector(".tdu-transportation-summary")))).forEach((e=>e.remove())),Array.from(n.querySelectorAll("*")).filter((e=>!e.textContent.trim())).forEach((e=>e.remove())),Array.from(n.querySelectorAll("*")).filter((e=>"true"===e.getAttribute("aria-hidden"))).forEach((e=>e.remove())),Array.from(n.querySelectorAll("[data-webbeat_link_prefix]")).forEach((e=>e.remove())),Array.from(n.querySelectorAll("*")).forEach((e=>{Array.from(e.attributes).filter((e=>"eid"!==e.name&&("href"!==e.name||e.value.startsWith("/")))).forEach((t=>e.removeAttribute(t.name)))}));const i=Array.from(n.querySelectorAll("h3, [eid]")).filter((e=>!e.closest('[role="alertdialog"]')));if(n=t.paramSerp.findCommonParent(Array.from(i)),!n)return"—";i.filter((e=>"A"===e.parentNode.tagName&&e.parentNode.getAttribute("href"))).forEach(((e,t)=>{let r=e.parentNode.getAttribute("href");r=(r||"").split("#:~:")[0];const s=e.textContent.trim();e.textContent=`### ${s} [${t+1}](${r})`})),document.body.appendChild(n);let o=n.innerText.split("\n");document.body.removeChild(n),o=o.map((e=>e.trim())).filter(((e,t,r)=>e&&r.indexOf(e)===t));const a=["Top stories"];o=o.map((e=>a.some((t=>e.startsWith(t)))?`### ${e}`:e));const l=["Search Results","People also search for","People also ask","Update Map Image","Choose what you’re giving feedback on","Or give general feedback","general feedback","Description","View all","Get there","More news","See more","About featured snippets"];if(o=o.filter((e=>!l.includes(e))),o.length>=2&&!o[0].startsWith("#")){const e=o[0];o[0]=o[1],o[1]=e}return o=o.join("\n").replace(/ +/g," ").trim(),o},t.paramSerp.findCommonParent=e=>{if(0===e.length)return null;if(1===e.length)return e[0].parentNode;let t=e[0];for(;t.parentNode;)if(t=t.parentNode,e.slice(1).every((e=>t.contains(e))))return t;return null}})(),(()=>{const{$chat:t}=e;t.paramYouTubeTranscript.getTranscript=async(e,t)=>{try{const r=await fetch(e,{credentials:"include"}),s=await r.text(),n=s.split("ytInitialPlayerResponse =")[1].split(";var")[0].split(";<\/script>")[0];let i=JSON.parse(n)?.captions?.playerCaptionsTracklistRenderer?.captionTracks;if(!i){const t=s.split('XSRF_TOKEN":"')[1].split('"')[0],r=JSON.parse(`"${t}"`),n=Math.floor(Date.now()/1e3)+3e3,o=`https://www.youtube.com/watch?v=${new URL(e).searchParams.get("v")}&bpctr=${n}&pbj=1`,a=await fetch(o,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`session_token=${encodeURIComponent(r)}`,credentials:"include"}),l=await a.text(),c=JSON.parse(l)?.playerResponse;i=c?.captions?.playerCaptionsTracklistRenderer?.captionTracks}if(!i)return{transcript:null};const o=i.find((e=>e.vssId.startsWith(".en")))||i.find((e=>"a.en"===e.vssId))||i[0];if(!o)return{transcript:null};let a=o.baseUrl.startsWith("/")?`https://www.youtube.com${o.baseUrl}`:o.baseUrl;const l=t?.params;if(l){const e=new URLSearchParams(a.split("?")[1]);for(const t in l)e.has(t)||["fmt","hl","lang","tlang"].includes(t)||(a+=`&${t}=${l[t]}`)}const c=await fetch(a,{credentials:"include"}),h=await c.text(),u=document.createElement("div");u.innerHTML=h;const d=[...u.querySelectorAll("text")];return{transcript:d.map((e=>({s:parseFloat(e.getAttribute("start")),d:parseFloat(e.getAttribute("dur")),t:e.innerText.replace(/<\/?[^>]+(>|$)/g,"").replaceAll("&#39;","'").replaceAll("&quot;",'"').replaceAll("\n"," ")})))}}catch(e){return{transcript:null,error:e.message||String(e)}}}})(),(()=>{const{$chat:t,$bus:r}=e;t.controller={init(){r.on("chat.paramSerp.toText",((...e)=>t.paramSerp.toText(...e))),r.on("chat.paramYouTubeTranscript.getTranscript",((...e)=>t.paramYouTubeTranscript.getTranscript(...e)))}}})(),(()=>{const{$engine:t,$bus:r,$env:s}=e;t.htmlToText=async e=>{if(s.is.bg)return await r.send("engine.htmlToText",e);if(!e)return e;const t=e.match(/<body[^>]*>([\s\S]*?)<\/body>/i);if(!t||!t[1])return null;let n=t[1];n=n.replaceAll(/src="[^"]*"/g,"").replaceAll(/href="[^"]*"/g,""),n=n.replaceAll(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replaceAll(/<script[^>]*>[\s\S]*?<\/script>/gi,"");let i=document.createElement("div");i.innerHTML=n;Array.from(i.querySelectorAll("head, script, style, img, svg, nav, footer, header, aside, iframe, video, audio, canvas, map, object, embed, applet, frame, frameset, noframes, noembed, noscript, link, meta, base, title")).forEach((e=>e.remove())),Array.from(i.querySelectorAll("*")).filter((e=>!e.textContent.trim())).forEach((e=>e.remove())),Array.from(i.querySelectorAll("*")).forEach((e=>{Array.from(e.attributes).forEach((t=>e.removeAttribute(t.name)))})),i.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach((e=>{const t=parseInt(e.tagName[1]);e.textContent="#".repeat(t)+` ${e.textContent}`})),document.body.appendChild(i);let o=i.innerText||"";return document.body.removeChild(i),o=o.replace(/ +/g," ").replace(/\n+/g,"\n").trim(),o=o.split("\n").map((e=>e.trim())),o=o.filter(((e,t)=>e&&o.indexOf(e)===t)).join("\n"),o}})(),(()=>{const{$engine:t,$bus:r}=e;t.controller={init(){r.on("engine.htmlToText",t.htmlToText),t.pdfController.init(),t.docController.init(),t.xlsController.init()}}})(),(()=>{const{$engine:t,$bus:r}=e;t.docController={init(){r.on("engine.docToText",this._docToText,this),r.on("engine.docxToText",this._docxToText,this)},_docToText:async()=>"<SYSTEM: FAILED TO READ DOC, ADVISE TO CONVERT TO DOCX AND REUPLOAD>",async _docxToText(e){try{return await this._readDocx(e)}catch(e){return"<SYSTEM: FAILED TO READ DOCX FILE>"}},async _readDocx(e){await this._loadMammoth();const t=await e.arrayBuffer();return(await window.mammoth.extractRawText({arrayBuffer:t})).value},_loadMammoth:async()=>new Promise(((e,t)=>{if(void 0!==window.mammoth)e();else{const r=document.createElement("script");r.src=chrome.runtime.getURL("js/mammoth.browser.min.js"),r.onload=()=>e(),r.onerror=()=>t(new Error("Failed to load mammoth.browser.min.js")),document.head.appendChild(r)}}))}})(),(()=>{const{$engine:t,$bus:r}=e;t.pdfController={init(){r.on("engine.pdfToText",this._pdfToText,this)},async _pdfToText(e){try{return await this._readPdf(e)}catch(e){return t.error("failed to read pdf",e),""}},async _readPdf(e){let r=window["pdfjs-dist/build/pdf"];if(!r){const e=e=>chrome.runtime.getURL(`/js/${e}.min.js`);try{await new Promise(((t,r)=>{const s=document.createElement("script");s.onload=t,s.onerror=r,s.type="text/javascript",s.src=e("pdf"),document.getElementsByTagName("head")[0].appendChild(s)}))}catch(e){return t.warn("failed loading pdfjs script",e),null}if(r=window["pdfjs-dist/build/pdf"],!r)return null;r.GlobalWorkerOptions.workerSrc=e("pdf.worker")}const s=await e.arrayBuffer(),n=await r.getDocument({data:s}).promise,i=async e=>(await e.getTextContent()).items.map((e=>e.str));let o=[];for(let e=1;e<=n.numPages;e++)await n.getPage(e).then(i).then((e=>{o=o.concat(e)}));return o.reduce(((e,t)=>""===t?e+"\n":e.endsWith("-")?e.slice(0,-1)+t:e+(0===e.length||e.endsWith("\n")?"":" ")+t),"")}}})(),(()=>{const{$engine:t,$bus:r}=e;t.xlsController={init(){r.on("engine.xlsToText",this._xlsToText,this),r.on("engine.xlsxToText",this._xlsxToText,this)},_xlsToText:async()=>"<SYSTEM: FAILED TO READ XLS, ADVISE TO CONVERT TO XLSX AND REUPLOAD>",async _xlsxToText(e){try{return await this._readXls(e)}catch(e){return"<SYSTEM: FAILED TO READ XLSX FILE>"}},async _readXls(e){return await this._loadSheetJS(),new Promise(((t,r)=>{const s=new FileReader;s.onload=e=>{try{const r=new Uint8Array(e.target.result),s=window.XLSX.read(r,{type:"array"});let n;for(const e of s.SheetNames){const t=s.Sheets[e],r=`!SHEET: ${e}\n`+window.XLSX.utils.sheet_to_csv(t);n=n?n+"\n\n"+r:r}t(n)}catch(e){r(e)}},s.onerror=()=>r(),s.readAsArrayBuffer(e)}))},_loadSheetJS:async()=>new Promise(((e,t)=>{if(void 0!==window.XLSX)e();else{const r=document.createElement("script");r.src=chrome.runtime.getURL("js/xlsx.mini.min.js"),r.onload=()=>e(),r.onerror=()=>t(new Error("Failed to load xlsx.mini.min.js")),document.head.appendChild(r)}}))}})(),(()=>{const{$grid:t,$bus:r,$env:s,$utils:n}=e;t.controller={init(){r.on("grid.ws.connect",this.connect.bind(this)),r.on("grid.ws.send",this.send.bind(this)),this.channels=[],this.ws=null},connect({channels:e,jwt:t,uuid:r}){if(e=(e||[]).join(","),this.channels===e)return;if(this.channels=e,!e.trim())return void(this.ws&&(this.ws.close(),this.ws=null));if(!e.trim())return;const s={channels:e,jwt:t,uuid:r,claim:0};this.createWebSocket(s)},send(e){if(this.ws&&this.ws.readyState===WebSocket.OPEN)try{t.log("sending message to websocket:",e),this.ws.send(JSON.stringify(e))}catch(e){t.error("failed sending message to websocket",e)}},reconnect(e,t){t=Math.min(2*t,15*n.time.MINUTE),setTimeout((()=>{this.channels===e.channels&&this.ws?.readyState!==WebSocket.OPEN&&this.createWebSocket(e,t)}),t)},createWebSocket(e,t=100){if(this.ws){this.ws.onopen=null,this.ws.onmessage=null,this.ws.onclose=null,this.ws.onerror=null;try{this.ws.close()}catch{}this.ws=null}const n=new URLSearchParams(e).toString(),i=`${s.gunUrl}/ws${n?"?"+n:""}`;try{this.ws=new WebSocket(i)}catch{return this.reconnect(e,t)}return new Promise((s=>{this.ws.onopen=()=>{t=1e3,s()},this.ws.onmessage=e=>{if("ready"===e.data)return;let t=e.data;t?.startsWith("{")&&t?.endsWith("}")&&(t=JSON.parse(t)),r.send("grid.ws.message",t)},this.ws.onclose=()=>{this.reconnect(e,t)},this.ws.onerror=()=>{this.reconnect(e,t)}}))}}})(),(()=>{const{$offscreen:t}=e;t.controller={init(){t.iframeController.init(),t.imageController.init(),t.utilsController.init()}}})(),(()=>{const{$offscreen:t,$bus:r,$env:s,$utils:n}=e;t.iframeController={init(){this._src=`${s.webUrl}/oi`,this._iframe=this._createIframe(),r.setIframe(this._iframe),this._manageIframeStability().then((()=>{}))},_createIframe(){const e=document.createElement("iframe");return e.src=this._src,e.name=`offscreen-iframe | ${chrome.runtime.getURL("/oi.js")}`,document.body.append(e),e},async _manageIframeStability(){navigator.onLine||(t.log("waiting for online..."),await new Promise((e=>{const t=()=>{navigator.onLine&&(navigator.connection.removeEventListener("change",t),e())};navigator.connection.addEventListener("change",t)})),this._iframe.src=this._src);const e=async(r=0)=>{if(await this._pingIframe())return;const s=r<4?3:60;t.log(`failed to start oi, trying again in ${s}s...`),await n.sleep(s*n.time.SECOND),this._iframe.src=this._src,await e(r+1)};await e(),setInterval((async()=>{await this._pingIframe()||(t.log("failed to ping oi, restarting..."),this._iframe.src=this._src)}),5*n.time.MINUTE)},_pingIframe:async()=>await Promise.race([r.poll("startup.oiReady").then((()=>!0)),n.sleep(5e3).then((()=>!1))])}})(),(()=>{const{$offscreen:t,$bus:r,$utils:s}=e;t.imageController={init(){r.on("offscreen.svgToImage",this._svgToImage,this),r.on("offscreen.createImagePreview",this._createImagePreview,this)},async _svgToImage({svgCode:e,width:t,height:r,dpr:n,quality:i}){const o=new Blob([e],{type:"image/svg+xml"}),a=await new Promise(((e,t)=>{const r=new FileReader;r.onerror=t,r.onload=()=>e(r.result),r.readAsDataURL(o)})),l=document.createElement("img");await new Promise(((e,t)=>{l.src=a,l.onload=e,l.onerror=()=>t("failed to load svg data url")}));const c=document.createElement("canvas"),h=c.getContext("2d");c.width=t*n,c.height=r*n,h.fillStyle="#fff",h.fillRect(0,0,c.width,c.height),h.drawImage(l,0,0,t,r,0,0,c.width,c.height);const u=await s.canvasToBlob(c,"image/webp",i);return URL.createObjectURL(u)},async _createImagePreview(e){const t=document.createElement("img"),r=URL.createObjectURL(e);t.src=r,await new Promise(((e,r)=>{t.onload=e,t.onerror=r}));const n=document.createElement("canvas");let i,o;n.width=660,n.height=462;const a=t.naturalWidth,l=t.naturalHeight,c=a/l,h=n.width/n.height;c<h?(i=a,o=a/h):(o=l,i=l*h);return n.getContext("2d").drawImage(t,0,0,i,o,0,0,n.width,n.height),await s.canvasToBlob(n,"image/webp",.5)}}})(),(()=>{const{$offscreen:t,$utils:r,$bus:s}=e;t.utilsController={init(){const e=r.ls;s.on("utils.ls.get",e.get,e),s.on("utils.ls.set",e.set,e),s.on("utils.ls.has",e.has,e),s.on("utils.ls.remove",e.remove,e);const t=r.objectUrl;s.on("utils.objectUrl.create",t.create,t),s.on("utils.objectUrl.revoke",t.revoke,t)}}})(),(()=>{const{$runner:t,$bus:r,$utils:s}=e;t.audioController={init(){this._synth=window.speechSynthesis,this._sounds={},this._voices={},this._setupVoices(),this._notifyVoicesChanged(),r.on("runner.audio.loadSrc",this._loadSrc,this),r.on("runner.audio.playSrc",this._playSrc,this),r.on("runner.audio.playVoice",this._playVoice,this),r.on("runner.audio.stopVoice",this._stopVoice,this),r.on("runner.audio.getVoices",this._getVoices,this)},_setupVoices(){const e=()=>{for(const e of this._synth.getVoices())this._voices[e.name]=e};e(),this._synth.addEventListener("voiceschanged",e)},_notifyVoicesChanged(){this._synth.addEventListener("voiceschanged",(()=>{r.send("runner.audio.vocesChanged")}))},_loadSrc(e){this._sounds[e]=new Audio(e)},_playSrc(e,t){const r=this._sounds[e];r&&(r.pause(),r.currentTime=0,setTimeout((()=>{r.volume=t,r.play()})))},_playVoice(e,t,r){this._synth.cancel(),setTimeout((()=>{const n=new window.SpeechSynthesisUtterance;n.text=s.clearFromTags(r),n.voice=this._voices[e],n.volume=t,this._synth.speak(n)}))},_stopVoice(){this._synth.cancel()},_getVoices(){return this._synth.getVoices().map((e=>{const t={};for(const r in e)t[r]=e[r];return t}))}}})(),(()=>{const{$runner:t}=e;t.controller={init(){t.audioController.init()}}})(),(()=>{const{$timer:t,$bus:r}=e;t.aliveController={init(){this._keepBgAlive()},_keepBgAlive(){setInterval((()=>r.send("timer.keepBgAlive")),2e4)}}})(),(()=>{const{$timer:t}=e;t.controller={init(){t.aliveController.init(),t.timingController.init(),t.workerController.init()}}})(),(()=>{const{$timer:t,$bus:r}=e;t.timingController={init(){this._timerIds=new Set,this._intervalsById={},r.on("timer.setTimeout",this._setTimeout,this),r.on("timer.clearTimeout",this._clearTimeout,this),r.on("timer.setInterval",this._setInterval,this),r.on("timer.clearInterval",this._clearInterval,this)},hasTimers(){return this._timerIds.size>0},async _setTimeout(e,t){this._timerIds.add(e),await new Promise((r=>{setTimeout((()=>{this._timerIds.delete(e),r()}),t)}))},_clearTimeout(e){this._timerIds.delete(e)},_setInterval(e,t){this._timerIds.add(e),this._intervalsById[e]=setInterval((()=>{r.send(`timer.setIntervalCall:${e}`)}),t)},_clearInterval(e){this._timerIds.delete(e),clearInterval(this._intervalsById[e]),delete this._intervalsById[e]}}})(),(()=>{const{$timer:t}=e;t.workerController={init(){this._MAX_ID=2147483647,this._lastId=0,this._idToCallback={},this._setupWorker("/js/timer-worker.min.js")},_generateId(){do{this._lastId===this._MAX_ID?this._lastId=0:this._lastId++}while(this._idToCallback.hasOwnProperty(this._lastId));return this._lastId},_setupWorker(e){const r=this._idToCallback;try{const s=new Worker(e);window.setInterval=(e,t)=>{const n=this._generateId();return r[n]={callback:e,parameters:Array.prototype.slice.call(arguments,2)},s.postMessage({name:"setInterval",id:n,time:t}),n},window.clearInterval=e=>{r.hasOwnProperty(e)&&(delete r[e],s.postMessage({name:"clearInterval",id:e}))},window.setTimeout=(e,t)=>{const n=this._generateId();return r[n]={callback:e,parameters:Array.prototype.slice.call(arguments,2),isTimeout:!0},s.postMessage({name:"setTimeout",id:n,time:t}),n},window.clearTimeout=e=>{r.hasOwnProperty(e)&&(delete r[e],s.postMessage({name:"clearTimeout",id:e}))},s.onmessage=e=>{const s=e.data.id;if(!s||!r.hasOwnProperty(s))return;const n=r[s],i=n.parameters;let o=n.callback;if(n.isTimeout&&delete r[s],"string"==typeof o)try{o=new Function(o)}catch(e){t.error("error parsing callback code string",e)}"function"==typeof o&&o.apply(window,i)},s.onerror=e=>{t.error("worker posted an error event",e)}}catch(e){t.error("failed setting up timer worker",e)}}}})(),(()=>{const{$bus:t,$env:r,$utils:s}=e;t.controller={async init(){t.on=this.on.bind(this),t.off=this.off.bind(this),t.once=this.once.bind(this),t.send=this._wrapThrowIfError(this.send),t.call=this._wrapThrowIfError(this.call),t.poll=this.poll.bind(this),t.getTabId=this.getTabId.bind(this),this._locus=r.getLocus(),this._serialize=this._serialize.bind(this),this._handlers={},this._is("pp")?(this._setupPp(),this._tabId=await t.getTabId()):this._is("bg")?(this._blobs={},this._channel=new BroadcastChannel("bus.channel"),this._setupBg()):this._is("cs")?await this._setupCs():this._is("nj")?this._setupNj():this._is("os")?(t.setIframe=e=>this._iframe=e,this._iframe=null,this._channel=new BroadcastChannel("bus.channel"),this._setupOs()):this._is("oi")&&this._setupOi()},on(e,t,r=null){this._on(e,null,t,r)},off(e,t=null){this._off(e,null,t)},once(e,t){const r=async(...s)=>(this.off(e,r),await t(...s));this.on(e,r)},async send(e,...r){if(s.is.numeric(e)){const t=Number(e);return e=r[0],r=r.slice(1),await this._pick([this._sendToCs(t,e,...r),this._sendToExt(t,e,...r)])}if(this._is("pp"))return await this._sendToExt(e,...r);if(this._is("nj"))return await this._sendToPage(e,...r);if(this._is("oi"))return await this._sendToParent(e,...r);if(this._is("bg","cs","os"))return await this._pick([this._sendToExt(e,...r),this._callHandlers({name:e,args:r},(e=>e.proxy))]);if(this._is("fg")){if("store.actions"===e)return;if("idb.change"===e)return;t.log(e,...r)}},async call(e,...t){return this._callHandlers({name:e,args:t},(e=>!e.proxy))},async poll(e,...t){return await s.waitFor((()=>this.send(e,...t)))},async getTabId(){if(this._is("bg"))return null;if(this._is("pp")){const e=new URL(location.href).searchParams.get("tabId");if(e)return Number(e)}const{tabId:e}=await this.send("bus.getTabData");return e},_on(e,t,r,s=null){this._handlers[e]||(this._handlers[e]=[]),this._is("cs","nj","oi")&&0===this._handlers[e].length&&this._sendToProxier("bus.proxy",e,!0);const n={fn:r,name:e};t&&(n.proxy=t),s&&(n.this=s),this._handlers[e].push(n)},_off(e,t=null,r=null){this._handlers[e]&&(this._handlers[e]=this._handlers[e].filter((e=>{const s=!r||r===e.fn,n=t===(e.proxy||null);return!s||!n})),0===this._handlers[e].length&&(delete this._handlers[e],this._is("cs","nj","oi")&&this._sendToProxier("bus.proxy",e,!1)))},_setupPp(){},_setupBg(){},async _setupCs(){},_setupNj(){},_setupOs(){chrome.runtime.onMessage.addListener(((e,t,r)=>{if(!this._isBusMsg(e))return;const s=this._callHandlers(e);return s?(s.then(this._serialize).then(r),!0):void 0})),window.addEventListener("message",(async({data:t})=>{if(!this._isBusMsg(t))return;if("bus.proxy"===t.name){const[r,s]=t.args;return s?this._on(r,"oi",((...e)=>this._sendToIframe(r,...e))):this._off(r,"oi"),void e(t)}const r=await this._pick([this._sendToExt(t.name,...t.args),this._callHandlers(t,(e=>!e.proxy))]);e(t,r)}));const e=(e,t=null)=>{this._iframe.contentWindow.postMessage({resId:e.reqId,result:t},"*")};this._channel.addEventListener("message",(({data:e})=>{const{blob:t,reqId:r}=e,n=s.objectUrl.create(t,!0);this._channel.postMessage({resId:r,objectUrl:n})}))},_setupOi(){},async _sendToExt(e,...r){let n=null;s.is.numeric(e)&&(n=Number(e),e=r[0],r=r.slice(1));const i=this._serialize(r),o=this._createBusMsg({name:e,argsStr:i,target:n}),a=await new Promise((e=>{try{chrome.runtime.sendMessage(o,(t=>{chrome.runtime.lastError?e(null):e(t)}))}catch(r){if("Extension context invalidated."===r.message)return;t.error(r),e(null)}}));return await this._deserialize(a)},async _sendToCs(e,t,...r){if(!chrome.tabs?.sendMessage)return await this.send("bus.sendToCs",e,t,...r);const s=this._serialize(r),n=this._createBusMsg({name:t,argsStr:s,target:"cs"}),i=await new Promise((t=>{chrome.tabs.sendMessage(e,n,(e=>{chrome.runtime.lastError?t(null):t(e)}))}));return await this._deserialize(i)},async _sendToPage(e,...t){const r=this._generateId(),s=this._createBusMsg({name:e,args:t,reqId:r,locus:this._locus});return window.postMessage(s,"*"),await this._waitForResponseMessage(r)},async _sendToIframe(e,...t){if(!this._iframe)return null;const r=this._generateId(),s=this._createBusMsg({name:e,args:t,reqId:r});return this._iframe.contentWindow.postMessage(s,"*"),await this._waitForResponseMessage(r)},async _sendToParent(e,...t){const r=this._generateId(),s=this._createBusMsg({name:e,args:t,reqId:r});return parent.postMessage(s,"*"),await this._waitForResponseMessage(r)},async _sendToProxier(e,...t){return this._is("cs")?await this._sendToExt(e,...t):this._is("nj")?await this._sendToPage(e,...t):this._is("oi")?await this._sendToParent(e,...t):void 0},_waitForResponseMessage:async e=>await new Promise((t=>{const r=({data:s})=>{!(!s||s.resId!==e)&&(window.removeEventListener("message",r),t(s.result))};window.addEventListener("message",r)})),_callHandlers({name:e,args:r,argsStr:s},n=null){let i=this._handlers[e];return i?(n&&(i=i.filter(n)),0===i.length?null:new Promise((async e=>{s&&(r=await this._deserialize(s));e(await this._pick(i.map((async e=>{try{return await e.fn.call(e.this,...r)}catch(r){return t.error(`failed to handle "${e.name}".`,r),r}}))))}))):null},_removeProxyHandlers(e){Object.keys(this._handlers).forEach((t=>{this._handlers[t]=this._handlers[t].filter((t=>t.proxy!==e)),0===this._handlers[t].length&&delete this._handlers[t]}))},_serialize(e){return s.is.nil(e)?null:JSON.stringify(e,((e,t)=>{if(s.is.blob(t)){if(this._is("bg")){const e=this._generateId();return this._blobs[e]=t,`bus.blob.${e}`}return`bus.blob.${s.objectUrl.create(t,!0)}`}return s.is.error(t)?`bus.error.${t.message}`:t}))},async _deserialize(e){if(!s.is.string(e))return null;const t=new Map,r=JSON.parse(e,((e,r)=>{const n=s.is.string(r);return n&&r.startsWith("bus.blob.")?(t.set(r,r.slice("bus.blob.".length)),r):n&&r.startsWith("bus.error.")?new Error(r.slice("bus.error.".length)):r}));return await Promise.all([...t.keys()].map((async e=>{let r;const s=t.get(e);r=s.startsWith("blob:")?s:await this._sendToExt("bus.blobIdToObjectUrl",s);const n=await fetch(r).then((e=>e.blob()));t.set(e,n)}))),this._applyBlobs(r,t)},_applyBlobs(e,t){if(t.has(e))return t.get(e);if(s.is.array(e)||s.is.object(e))for(const r in e)e[r]=this._applyBlobs(e[r],t);return e},async _blobIdToObjectUrl(e){},async _blobToObjectUrl(e){},_is(...e){return e.includes(this._locus)},_isBusMsg:t=>t&&t.$bus&&t.appName===e.name,_createBusMsg:t=>({$bus:!0,appName:e.name,...t}),_generateId:()=>`bus-${Date.now()}-${Math.random().toString(36).slice(2)}`,_wrapThrowIfError(e){return async(...t)=>{const r=await e.call(this,...t);if(s.is.error(r))throw r;return r}},_pick:async(e=[])=>0===e.length?null:await new Promise((t=>{let r=0;e.forEach((async n=>{const i=await n;return s.is.nil(i)?r===e.length-1?t(null):void r++:t(i)}))}))}})(),(()=>{const{$env:t}=e;t.getLocus=()=>{const{protocol:e,host:t,pathname:r,href:s}=location;return"https://harpa.ai/oi"===s||"http://localhost:3000/oi"===s||"http://localhost:3010/oi"===s?"oi":"chrome-extension:"!==e&&chrome?.runtime?.getURL?"cs":"localhost:3050"===t?"fg":"chrome-extension:"!==e?"nj":"/harpa.html"===r?"pp":"/offscreen.html"===r?"os":"bg"}})(),(()=>{const{$env:t,$utils:r}=e;t.controller={async init(){const s=t.getLocus(),n=await r.ls.get("env.is")||e.env;Object.assign(t,{env:n,locus:s,version:e.version,versionNumber:r.versionNumber(e.version),platform:this._getPlatform(),browser:this._getBrowser(),webUrl:"https://harpa.ai",apiUrl:"https://api.harpa.ai/api/v1",gunUrl:"https://gun.harpa.ai",globalEditorUrl:"https://app.harpa.ai/#global",jwtCookieDomain:"harpa.ai",makeAppInviteUrl:"https://www.make.com/en/hq/app-invitation/c98499c16cfa22f1051f64346ef91aaa",extReviewUrl:"https://chromewebstore.google.com/detail/harpa-ai-automation-agent/eanggfilgoajaocelnaflolkadkeghjp/reviews",mixpanel:{token:"7958323a20a869de3c57712bfe521a6f"},contactEmail:"support@harpa.ai",discordUrl:"https://discord.gg/B9Evx82m4K",showWelcomeOnUpdate:!0,is:{pp:"pp"===s,bg:"bg"===s,cs:"cs"===s,nj:"nj"===s,os:"os"===s,fg:"fg"===s,test:"test"===n,beta:"beta"===n,production:"production"===n,development:"development"===n,popup:"pp"===s&&location.search.includes("?popup"),sandbox:"pp"===s&&location.search.includes("?sandbox"),sidePanel:"pp"===s&&location.search.includes("&tabId")},features:await this._initFeatures({debug:"development"===n||"beta"===n,taskImport:!0,taskExport:!0,library:!1,changesTracking:!1,actionsReporting:!1,doubleCheck:!1,emailActionFromField:!1}),options:{}});await r.ls.get("$env.useDevServer")&&(t.log("using dev server"),Object.assign(t,{webUrl:"http://localhost:3010",apiUrl:"http://localhost:3011/api/v1",gunUrl:"http://localhost:3002",jwtCookieDomain:"localhost"})),Object.assign(t,{welcomeUrl:`${t.webUrl}/welcome`,contactUsUrl:`${t.webUrl}/#contact-us`,jwtCookieUrl:t.webUrl}),"development"===n&&(t.dev=this.useDevServer.bind(this))},async useDevServer(e=!0){e?await r.ls.set("$env.useDevServer",!0):await r.ls.remove("$env.useDevServer")},async _initFeatures(e={}){const t={};for(const s in e)t[s]=await r.ls.get(`$env.features.${s}`,e[s]);return t},_getPlatform(){const e=navigator.platform.toLowerCase();return e.startsWith("mac")?"mac":e.startsWith("linux")?"linux":"win"},_getBrowser(){const e=navigator.userAgent;return navigator.brave?"Brave":e.includes("Edg")?"Edge":e.includes("OPR")?"Opera":e.includes("Chrome")?globalThis.chrome?"Chrome":"Chromium":"Chrome"}}})(),(()=>{const{$startup:t,$ai:r,$bus:s,$chat:n,$engine:i,$env:o,$offscreen:a,$runner:l,$timer:c,$grid:h}=e;t.controller={async init(){await s.controller.init(),await o.controller.init(),await c.controller.init(),await r.controller.init(),await n.controller.init(),await i.controller.init(),await l.controller.init(),await a.controller.init(),await h.controller.init(),s.on("startup.osReady",(()=>!0)),t.logDev("os ready")}},t.controller.init()})()})();